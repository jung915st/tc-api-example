<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Domain Admin Suite v<?= appVersion ?></title>
  
  <!-- Bootstrap 5 & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center; 
      justify-content: flex-start;
      padding-top: 20px;
    }
    
    .main-container {
      width: 100%;
      max-width: 1200px;
      padding: 0 15px;
    }

    .card {
      border: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    /* Tabs */
    .nav-tabs .nav-link { color: #495057; font-weight: 500; }
    .nav-tabs .nav-link.active { color: #0d6efd; border-top: 3px solid #0d6efd; background-color: #fff; }

    /* Loading Overlay */
    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.85);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    /* Scrollable Areas */
    .table-scroll { max-height: 500px; overflow-y: auto; }
    .checklist-scroll { max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; background: #fff; }

    /* Filter Bars */
    .filters-bar { background-color: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; }
    .batch-result-scroll { max-height: 220px; overflow-y: auto; }

    /* Email Editor specific */
    textarea.code-editor {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9rem;
      background-color: #2d2d2d;
      color: #f8f8f2;
    }
  </style>
</head>
<body>

  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div id="loadingText" class="mt-3 text-secondary fw-bold">Processing...</div>
  </div>

  <div class="main-container">
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="mb-0">Domain Admin Suite</h3>
        <small class="text-muted">Version <?= appVersion ?> | UTC+8</small>
      </div>
      <div>
        <button class="btn btn-outline-secondary btn-sm" onclick="runConnectivityTest()">Test API Connection</button>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="classroom-tab" data-bs-toggle="tab" data-bs-target="#classroom" type="button" onclick="loadCourses();">Classroom Manager</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" onclick="loadOUs('ouSelect')">User Lifecycle</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups" type="button" onclick="loadGroupsForSelectors()">Groups & Members</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="drive-tab" data-bs-toggle="tab" data-bs-target="#drive" type="button">Drive Audit</button>
      </li>
      <!-- Feature 6: Email Tab -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email" type="button">Email Notify</button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="adminTabsContent">
      
      <!-- ==================== TAB 1: CLASSROOM ==================== -->
      <div class="tab-pane fade show active" id="classroom" role="tabpanel">
        <div class="row">
          
          <!-- Left Column: Manage Courses -->
          <div class="col-lg-7">
            
            <!-- Create Course Card -->
            <div class="card bg-light mb-3">
              <div class="card-header border-0 bg-transparent fw-bold text-primary">
                <i class="bi bi-plus-circle"></i> Create New Course
              </div>
              <div class="card-body">
                <div class="row g-2">
                  <div class="col-md-8">
                    <input type="text" id="newCourseName" class="form-control" placeholder="Course Name (Required)">
                  </div>
                  <div class="col-md-4">
                    <input type="text" id="newCourseSection" class="form-control" placeholder="Section (Opt)">
                  </div>
                  
                  <!-- Owner (Fixed) -->
                  <div class="col-md-12">
                    <label class="form-label small text-muted mb-1">Course Owner (Fixed)</label>
                    <input type="text" class="form-control form-control-sm" value="Me (Admin) - Cannot be changed" disabled readonly>
                  </div>

                  <!-- Teacher Selection Logic -->
                  <div class="col-md-12">
                    <label class="form-label small text-muted mb-1">Assign Teacher (Optional)</label>
                    <div class="input-group">
                      <select id="newCourseTeacher" class="form-select">
                        <option value="me" selected>None (Owner only)</option>
                      </select>
                      <!-- Filter Teachers by OU -->
                      <select id="teacherOuFilter" class="form-select" onchange="loadTeacherCandidates(this.value)" style="max-width: 40%;">
                        <option value="">Search Teacher by OU...</option>
                        <!-- Populated via JS initOUs -->
                      </select>
                    </div>
                  </div>

                  <div class="col-12 text-end mt-2">
                    <button class="btn btn-success px-4" onclick="createCourse()">Create Course</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Batch Create Card -->
            <div class="card mb-3">
              <div class="card-header bg-white fw-bold text-primary">
                <i class="bi bi-upload"></i> Batch Create Courses (CSV / TSV)
              </div>
              <div class="card-body">
                <div class="row g-2 align-items-end">
                  <div class="col-md-8">
                    <label class="form-label small text-muted mb-1">Upload file</label>
                    <input type="file" id="batchCourseFile" class="form-control" accept=".csv,.tsv,text/csv,text/tab-separated-values">
                  </div>
                  <div class="col-md-4 d-grid">
                    <button class="btn btn-primary" onclick="uploadBatchCourses()">
                      <i class="bi bi-cloud-arrow-up"></i> Upload & Create
                    </button>
                  </div>
                  <div class="col-12 d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="downloadBatchTemplate('csv')">
                      <i class="bi bi-download"></i> CSV Sample
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="downloadBatchTemplate('tsv')">
                      <i class="bi bi-download"></i> TSV Sample
                    </button>
                  </div>
                  <div class="col-12">
                    <small class="text-muted">
                      Required headers: <code>name</code>, <code>teacherEmail</code>. Optional: <code>section</code>, <code>description</code>.
                      Maximum 100 non-empty rows per upload.
                    </small>
                  </div>
                </div>
                <div id="batchCourseResult" class="mt-3 small text-muted">No batch upload executed yet.</div>
              </div>
            </div>

            <!-- List Courses Card -->
            <div class="card">
              <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <span>Active Courses</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadCourses()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
              </div>
              <div class="card-body p-0 table-scroll">
                <table class="table table-hover mb-0 align-middle">
                  <thead class="table-light sticky-top">
                    <tr>
                      <th>Name</th>
                      <th>Section</th>
                      <th>Enroll Code</th>
                      <th class="text-end">Action</th>
                    </tr>
                  </thead>
                  <tbody id="courseTableBody">
                    <tr><td colspan="4" class="text-center text-muted py-3">Loading courses...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Right Column: Enroll Students -->
          <div class="col-lg-5">
            <div class="card h-100">
              <div class="card-header bg-white fw-bold">
                <i class="bi bi-people"></i> Enroll Students
              </div>
              <div class="card-body d-flex flex-column">
                
                <!-- Step 1: Select Course -->
                <div class="mb-3">
                  <label class="form-label text-muted small fw-bold">1. TARGET COURSE</label>
                  <select id="enrollCourseSelect" class="form-select bg-light">
                    <option value="" disabled selected>Select a course from the left...</option>
                  </select>
                </div>

                <hr class="my-2">

                <!-- Step 2: Select Source -->
                <div class="mb-2">
                  <label class="form-label text-muted small fw-bold">2. SELECT STUDENTS (FROM OU)</label>
                  <div class="input-group">
                    <select id="classOuSelect" class="form-select">
                      <option value="" disabled selected>Select OU...</option>
                      <!-- Populated via JS initOUs -->
                    </select>
                    <button class="btn btn-outline-primary" onclick="loadStudentsFromOu('classOuSelect', 'studentCheckList')">Load</button>
                  </div>
                </div>

                <!-- Student Checklist -->
                <div class="mb-3 flex-grow-1 position-relative">
                   <div id="studentCheckList" class="checklist-scroll h-100">
                     <div class="text-center text-muted mt-5">
                       <i class="bi bi-arrow-up-circle d-block fs-4 mb-2"></i>
                       Select an OU and click "Load" to see students.
                     </div>
                   </div>
                </div>

                <!-- Action -->
                <button class="btn btn-primary w-100 py-2" onclick="enrollCheckedStudents()">
                  <i class="bi bi-person-plus"></i> Enroll Selected Students
                </button>

              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- ==================== TAB 2: USER LIFECYCLE ==================== -->
      <div class="tab-pane fade" id="users" role="tabpanel">
        
        <!-- Filters -->
        <div class="filters-bar">
          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label class="form-label small fw-bold">Source OU</label>
              <select id="ouSelect" class="form-select form-select-sm">
                 <option value="" disabled selected>Select OU...</option>
                 <!-- Populated via JS initOUs -->
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold">Status Condition</label>
              <select id="loginStatusSelect" class="form-select form-select-sm" onchange="toggleDatePicker()">
                <option value="ALL">All Users</option>
                <option value="NEVER_LOGIN">Never Logged In</option>
                <option value="BEFORE_DATE">Logged In Before Date</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label small fw-bold">Date Limit</label>
              <input type="date" id="filterDate" class="form-control form-control-sm" disabled>
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary btn-sm w-100" onclick="filterUsers()">Search Users</button>
            </div>
          </div>
        </div>

        <!-- Toolbar with Dropdown Move -->
        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
          
          <!-- Group 1: Suspend -->
          <div>
            <button class="btn btn-outline-danger btn-sm" onclick="suspendSelected()">
              <i class="bi bi-pause-circle"></i> Suspend & Queue Delete
            </button>
          </div>

          <!-- Group 2: Move OU (Updated with Dropdown) -->
          <div class="input-group input-group-sm" style="width: auto;">
             <span class="input-group-text bg-light fw-bold">Move To:</span>
             <select id="targetOuSelect" class="form-select" style="max-width: 250px;">
                <option value="" disabled selected>Loading OUs...</option>
                <!-- Populated via JS initOUs -->
             </select>
             <button class="btn btn-outline-secondary" onclick="bulkMoveUsers()">
               <i class="bi bi-folder-symlink"></i> Execute Move
             </button>
          </div>

          <!-- Group 3: Sync/Install -->
          <div class="btn-group ms-auto">
            <button class="btn btn-outline-success btn-sm" onclick="syncSuspended()">Sync Existing</button>
            <button class="btn btn-dark btn-sm" onclick="installTrigger()">Install Auto-Delete Trigger</button>
          </div>
        </div>

        <!-- Table -->
        <div class="card">
          <div class="card-body p-0 table-scroll">
            <table class="table table-hover mb-0">
              <thead class="table-light sticky-top">
                <tr>
                  <th width="40"><input type="checkbox" onchange="toggleAll(this, '.user-check')"></th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Last Login (UTC+8)</th>
                  <th>Status</th>
                  <th>OU</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <tr><td colspan="6" class="text-center text-muted py-3">Use filters to display users.</td></tr>
              </tbody>
            </table>
          </div>
          <div class="card-footer bg-white text-muted small">
            <span id="userCount">0</span> users found.
          </div>
        </div>
      </div>

      <!-- ==================== TAB 3: GROUPS & MEMBERS ==================== -->
      <div class="tab-pane fade" id="groups" role="tabpanel">
        <div class="row g-3">

          <!-- Left: Batch Create & Group List -->
          <div class="col-lg-6">
            <div class="card mb-3">
              <div class="card-header bg-white fw-bold text-primary">
                <i class="bi bi-collection"></i> Batch Create Groups (CSV / TSV)
              </div>
              <div class="card-body">
                <div class="row g-2 align-items-end">
                  <div class="col-md-8">
                    <label class="form-label small text-muted mb-1">Upload file</label>
                    <input type="file" id="batchGroupFile" class="form-control" accept=".csv,.tsv,text/csv,text/tab-separated-values">
                  </div>
                  <div class="col-md-4 d-grid">
                    <button class="btn btn-primary" onclick="uploadBatchGroups()">
                      <i class="bi bi-cloud-arrow-up"></i> Upload & Create
                    </button>
                  </div>
                  <div class="col-12 d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="downloadGroupBatchTemplate('csv')">
                      <i class="bi bi-download"></i> CSV Sample
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="downloadGroupBatchTemplate('tsv')">
                      <i class="bi bi-download"></i> TSV Sample
                    </button>
                  </div>
                  <div class="col-12">
                    <small class="text-muted">
                      Required header: <code>email</code>. Optional: <code>name</code>, <code>description</code>.
                      Maximum 100 non-empty rows per upload.
                    </small>
                  </div>
                </div>
                <div id="batchGroupResult" class="mt-3 small text-muted">No group batch upload executed yet.</div>
              </div>
            </div>

            <div class="card">
              <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-people-fill"></i> Existing Groups</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadGroupsForSelectors()">
                  <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
              </div>
              <div class="card-body p-0 table-scroll">
                <table class="table table-hover mb-0 table-sm">
                  <thead class="table-light sticky-top">
                    <tr>
                      <th>Email</th>
                      <th>Name</th>
                      <th class="text-end">Members</th>
                    </tr>
                  </thead>
                  <tbody id="groupTableBody">
                    <tr><td colspan="3" class="text-center text-muted py-3">Open this tab to load groups.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Right: Bulk Member Assignment -->
          <div class="col-lg-6">
            <div class="card h-100">
              <div class="card-header bg-white fw-bold">
                <i class="bi bi-person-plus-fill"></i> Assign Members to Groups
              </div>
              <div class="card-body d-flex flex-column">
                <div class="mb-3">
                  <label class="form-label small text-muted fw-bold">1. TARGET GROUPS (MULTI-SELECT)</label>
                  <select id="groupTargetSelect" class="form-select" multiple size="8"></select>
                  <small class="text-muted">Hold Ctrl/Cmd to select multiple groups.</small>
                </div>

                <div class="mb-3">
                  <label class="form-label small text-muted fw-bold">2. MEMBER ROLE</label>
                  <select id="groupMemberRole" class="form-select form-select-sm" style="max-width: 220px;">
                    <option value="MEMBER" selected>MEMBER</option>
                    <option value="MANAGER">MANAGER</option>
                    <option value="OWNER">OWNER</option>
                  </select>
                </div>

                <div class="mb-2">
                  <label class="form-label small text-muted fw-bold">3. SELECT USERS FROM OU</label>
                  <div class="input-group">
                    <select id="groupMemberOuSelect" class="form-select">
                      <option value="" disabled selected>Select OU...</option>
                    </select>
                    <button class="btn btn-outline-primary" onclick="loadStudentsFromOu('groupMemberOuSelect', 'groupMembersCheckList')">Load</button>
                  </div>
                </div>

                <div class="mb-3 flex-grow-1 position-relative">
                  <div id="groupMembersCheckList" class="checklist-scroll h-100">
                    <div class="text-center text-muted mt-5">
                      <small>Select an OU and click "Load"</small>
                    </div>
                  </div>
                </div>

                <small class="text-muted mb-3">
                  Note: for newly created groups, member insertion can fail temporarily during propagation. If so, wait at least 1 minute and retry.
                </small>

                <button class="btn btn-primary w-100" onclick="assignSelectedMembersToGroups()">
                  <i class="bi bi-person-check-fill"></i> Assign Selected Users
                </button>
                <div id="groupMemberAssignResult" class="mt-3 small text-muted">No assignment executed yet.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== TAB 4: DRIVE AUDIT ==================== -->
      <div class="tab-pane fade" id="drive" role="tabpanel">
        
        <div class="filters-bar">
          <div class="row g-3 align-items-end">
            <div class="col-md-6">
              <label class="fw-bold small">Modified Before (Date Filter)</label>
              <div class="input-group">
                <input type="date" id="driveFilterDate" class="form-control">
                <button class="btn btn-info text-white" onclick="auditDrive()">
                  <i class="bi bi-search"></i> Find Large, Old Files
                </button>
              </div>
            </div>
            <div class="col-md-6 text-end">
               <span class="text-muted small">
                 <i class="bi bi-info-circle"></i> Results sorted by Largest Size first.
                 Includes Shared Drives.
               </span>
            </div>
          </div>
        </div>
        
        <!-- Batch Actions -->
        <div class="d-flex gap-2 mb-2">
          <button class="btn btn-warning btn-sm" onclick="manageFiles('archive')">
            <i class="bi bi-archive"></i> Archive Selected (Rename)
          </button>
          <button class="btn btn-danger btn-sm" onclick="manageFiles('delete')">
            <i class="bi bi-trash"></i> Delete Selected
          </button>
        </div>

        <div class="card">
          <div class="card-body p-0 table-scroll">
            <table class="table table-striped mb-0 table-sm">
              <thead class="table-light sticky-top">
                <tr>
                  <th width="40"><input type="checkbox" onchange="toggleAll(this, '.file-check')"></th>
                  <th>File Name</th>
                  <th>Owner</th>
                  <th>Modified</th>
                  <th>Size</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody id="driveTableBody">
                <tr><td colspan="6" class="text-center text-muted py-3">Select a date to find files.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== TAB 5: EMAIL NOTIFICATION (Feature 6) ==================== -->
      <div class="tab-pane fade" id="email" role="tabpanel">
        <div class="row h-100">
            
            <!-- Left: Receiver Selection -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header bg-white fw-bold">
                        <i class="bi bi-person-check"></i> 1. Select Recipients
                    </div>
                    <div class="card-body d-flex flex-column">
                        <div class="mb-3">
                            <label class="form-label small text-muted fw-bold">SOURCE OU</label>
                            <div class="input-group">
                                <select id="emailOuSelect" class="form-select form-select-sm">
                                    <option value="" disabled selected>Select OU...</option>
                                    <!-- Populated via JS initOUs -->
                                </select>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadStudentsFromOu('emailOuSelect', 'emailRecipientsList')">Load</button>
                            </div>
                        </div>

                        <div class="mb-3 flex-grow-1 position-relative">
                            <div id="emailRecipientsList" class="checklist-scroll h-100">
                                <div class="text-center text-muted mt-5">
                                    <small>Select an OU and click "Load"</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Email Editor -->
            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-header bg-white fw-bold d-flex justify-content-between">
                        <span><i class="bi bi-envelope-paper"></i> 2. Compose Email</span>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                Insert Variable
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="insertAtCursor('{name}')">User Name {name}</a></li>
                                <li><a class="dropdown-item" href="#" onclick="insertAtCursor('{email}')">User Email {email}</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Subject</label>
                            <input type="text" id="emailSubject" class="form-control" placeholder="e.g., Important Notice regarding your account">
                        </div>
                        <div class="mb-3 h-100">
                            <label class="form-label small fw-bold">Body (HTML Supported)</label>
                            <textarea id="emailBody" class="form-control code-editor" style="height: 350px;">
<p>Dear {name},</p>
<p>This is a notification regarding your account: <b>{email}</b>.</p>
<p>Please ensure you backup your files immediately.</p>
<br>
<p style="color: grey;">IT Admin Team</p>
                            </textarea>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-end">
                        <button class="btn btn-primary px-4" onclick="sendBatchEmail()">
                            <i class="bi bi-send"></i> Send Email to Selected
                        </button>
                    </div>
                </div>
            </div>

        </div>
      </div>

    </div>
  </div>

  <!-- JavaScript Logic -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- GLOBAL UTILS ---
    window.onload = function() {
      // Init Drive Date to 1 year ago by default
      const d = new Date();
      d.setFullYear(d.getFullYear() - 1);
      document.getElementById('driveFilterDate').value = d.toISOString().split('T')[0];
      
      // Load initial data
      loadCourses();
      loadGroupsForSelectors();
      
      // Load OUs for all dropdowns immediately on page load
      initOUs();
    };

    function setLoader(isLoading, text) {
      document.getElementById('loadingText').innerText = text || "Processing...";
      document.getElementById('loadingOverlay').style.display = isLoading ? 'flex' : 'none';
    }

    // UPDATED: Toggle logic to support multiple tabs
    function toggleAll(source, selector) {
      const container = source.closest('.checklist-scroll') || source.closest('table');
      if (container) {
          container.querySelectorAll(selector).forEach(cb => cb.checked = source.checked);
      } else {
          document.querySelectorAll(selector).forEach(cb => cb.checked = source.checked);
      }
    }

    function getCheckedValues(selector) {
      return Array.from(document.querySelectorAll(selector + ':checked')).map(cb => cb.value);
    }

    function escapeHtml(text) {
      return String(text || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // --- NEW: CENTRALIZED OU LOADING ---
    function initOUs() {
      // setLoader(true, "Loading Organization Units..."); // Optional: silent load to avoid blocking UI
      google.script.run.withSuccessHandler(ous => {
        // setLoader(false);
        const options = ous.map(ou => `<option value="${ou}">${ou}</option>`).join('');

        // 1. User Filter (User Lifecycle Tab)
        const userFilter = document.getElementById('ouSelect');
        userFilter.innerHTML = '<option value="" disabled selected>Select OU...</option><option value="ALL">All OUs</option>' + options;

        // 2. Teacher Filter (Classroom Tab)
        const teacherFilter = document.getElementById('teacherOuFilter');
        teacherFilter.innerHTML = '<option value="">Search Teacher by OU...</option><option value="ALL">All OUs</option>' + options;

        // 3. Student Source (Classroom Tab)
        const studentSource = document.getElementById('classOuSelect');
        studentSource.innerHTML = '<option value="" disabled selected>Select OU...</option>' + options;

        // 4. Target Move (User Lifecycle Tab)
        const targetMove = document.getElementById('targetOuSelect');
        if(targetMove) targetMove.innerHTML = '<option value="" disabled selected>Select Target OU...</option>' + options;
        
        // 5. Group Member Source (Groups Tab)
        const groupMemberSource = document.getElementById('groupMemberOuSelect');
        if(groupMemberSource) groupMemberSource.innerHTML = '<option value="" disabled selected>Select OU...</option>' + options;

        // 6. Email Source (Feature 6)
        const emailSource = document.getElementById('emailOuSelect');
        if(emailSource) emailSource.innerHTML = '<option value="" disabled selected>Select OU...</option>' + options;

      }).withFailureHandler(err => {
        // setLoader(false);
        console.error("Failed to load OUs: " + err.message);
        // Fallback to alert if critical
      }).getDomainOUs();
    }

    // --- CLASSROOM FUNCTIONS ---

    function loadCourses() {
      const tbody = document.getElementById('courseTableBody');
      const enrollSelect = document.getElementById('enrollCourseSelect');
      
      google.script.run.withSuccessHandler(courses => {
        tbody.innerHTML = '';
        enrollSelect.innerHTML = '<option value="" disabled selected>Select a course...</option>';

        if (courses.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No courses found.</td></tr>';
          return;
        }

        courses.forEach(c => {
          tbody.innerHTML += `
            <tr>
              <td><strong>${c.name}</strong></td>
              <td>${c.section}</td>
              <td><code class="text-primary">${c.enrollmentCode || 'N/A'}</code></td>
              <td class="text-end">
                <button class="btn btn-outline-danger btn-sm" onclick="deleteCourse('${c.id}')" title="Delete Course">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          `;
          enrollSelect.innerHTML += `<option value="${c.id}">${c.name} (${c.section})</option>`;
        });
      }).withFailureHandler(err => {
         tbody.innerHTML = `<tr><td colspan="4" class="text-danger">Error: ${err.message}</td></tr>`;
      }).listCourses();
    }

    function createCourse() {
      const name = document.getElementById('newCourseName').value;
      const section = document.getElementById('newCourseSection').value;
      const teacherEmail = document.getElementById('newCourseTeacher').value;
      
      if (!name) return alert("Course Name is required.");
      
      setLoader(true, "Creating Course...");
      google.script.run.withSuccessHandler(res => {
        setLoader(false);
        alert(`Course Created!\nName: ${res.name}\nCode: ${res.enrollmentCode}`);
        document.getElementById('newCourseName').value = '';
        document.getElementById('newCourseSection').value = '';
        loadCourses();
      }).withFailureHandler(err => {
        setLoader(false);
        alert("Creation Failed: " + err.message);
      }).createClassroomCourse({ name, section, teacherEmail });
    }

    function uploadBatchCourses() {
      const input = document.getElementById('batchCourseFile');
      const file = input.files && input.files[0];
      if (!file) return alert("Please choose a CSV or TSV file.");

      const lowerName = file.name.toLowerCase();
      if (!(lowerName.endsWith('.csv') || lowerName.endsWith('.tsv'))) {
        return alert("Only CSV or TSV files are supported.");
      }

      const reader = new FileReader();
      reader.onload = evt => {
        const content = evt.target.result || "";
        setLoader(true, `Processing ${file.name}...`);
        google.script.run.withSuccessHandler(result => {
          setLoader(false);
          renderBatchResult(result);
          loadCourses();
        }).withFailureHandler(err => {
          setLoader(false);
          alert("Batch upload failed: " + err.message);
        }).processBatchCourseUpload(file.name, content);
      };
      reader.onerror = () => alert("Failed to read the selected file.");
      reader.readAsText(file);
    }

    function downloadBatchTemplate(format) {
      setLoader(true, `Preparing ${format.toUpperCase()} template...`);
      google.script.run.withSuccessHandler(res => {
        setLoader(false);
        const blob = new Blob([res.content], { type: res.mimeType || "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = res.filename || `classroom-course-batch-template.${format}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }).withFailureHandler(err => {
        setLoader(false);
        alert("Template download failed: " + err.message);
      }).getCourseBatchTemplate(format);
    }

    function renderBatchResult(result) {
      const el = document.getElementById('batchCourseResult');
      if (!el || !result) return;

      const summary = result.summary || {};
      const statusClass = (summary.errors || summary.partial) ? "alert-warning" : "alert-success";
      const createdHtml = (result.created || []).length
        ? `<div class="mt-2"><strong>Created (${result.created.length})</strong><ul class="mb-0 ps-3 batch-result-scroll">${result.created.map(item => {
            const detail = item.teacherStatus === "FAILED" && item.teacherError
              ? ` (Teacher error: ${escapeHtml(item.teacherError)})`
              : "";
            return `<li>Row ${item.rowNumber}: ${escapeHtml(item.name)} (${escapeHtml(item.section || "-")}) - ${escapeHtml(item.teacherStatus)}${detail}</li>`;
          }).join("")}</ul></div>`
        : "";
      const skippedHtml = (result.skipped || []).length
        ? `<div class="mt-2"><strong>Skipped (${result.skipped.length})</strong><ul class="mb-0 ps-3 batch-result-scroll">${result.skipped.map(item => `<li>Row ${item.rowNumber}: ${escapeHtml(item.reason)}</li>`).join("")}</ul></div>`
        : "";
      const errorsHtml = (result.errors || []).length
        ? `<div class="mt-2"><strong>Errors (${result.errors.length})</strong><ul class="mb-0 ps-3 batch-result-scroll">${result.errors.map(item => `<li>Row ${item.rowNumber} [${escapeHtml(item.stage || "UNKNOWN")}]: ${escapeHtml(item.message)}</li>`).join("")}</ul></div>`
        : "";

      el.innerHTML = `
        <div class="alert ${statusClass} mb-0">
          <div><strong>File:</strong> ${escapeHtml(result.fileName || "upload")}</div>
          <div><strong>Mode:</strong> ${escapeHtml(result.delimiter || "")}</div>
          <div><strong>Rows:</strong> ${summary.totalRows || 0} | Attempted: ${summary.attemptedRows || 0} | Created: ${summary.created || 0} | Partial: ${summary.partial || 0} | Skipped: ${summary.skipped || 0} | Errors: ${summary.errors || 0}</div>
          ${createdHtml}
          ${skippedHtml}
          ${errorsHtml}
        </div>
      `;
    }

    function deleteCourse(id) {
      if (!confirm("Are you sure? This will delete the course permanently.")) return;
      setLoader(true, "Deleting Course...");
      google.script.run.withSuccessHandler(msg => {
        setLoader(false);
        alert(msg);
        loadCourses();
      }).withFailureHandler(err => {
        setLoader(false);
        alert("Delete Failed: " + err.message);
      }).deleteClassroomCourse(id);
    }

    function loadTeacherCandidates(ouPath) {
      if (!ouPath) return;
      setLoader(true, "Finding teachers in OU...");
      google.script.run.withSuccessHandler(users => {
        setLoader(false);
        const sel = document.getElementById('newCourseTeacher');
        sel.innerHTML = '<option value="me">None (Owner only)</option>';
        if (users.length === 0) {
           sel.innerHTML += '<option disabled>No users in this OU</option>';
        } else {
           users.forEach(u => {
             sel.innerHTML += `<option value="${u.email}">${u.name} (${u.email})</option>`;
           });
        }
      }).getFilteredUsers(ouPath, "ALL", null);
    }

    function resolveChecklistClass_(containerId) {
      if (containerId === 'emailRecipientsList') return 'email-check';
      if (containerId === 'groupMembersCheckList') return 'group-member-check';
      return 'student-check';
    }

    // UPDATED: Now reusable for Classroom, Groups, and Email tabs
    function loadStudentsFromOu(selectId, containerId) {
      const selectEl = document.getElementById(selectId || 'classOuSelect');
      const containerEl = document.getElementById(containerId || 'studentCheckList');
      const ou = selectEl.value;

      if (!ou) return alert("Please select an OU first.");
      
      setLoader(true, `Loading users from ${ou}...`);
      google.script.run.withSuccessHandler(users => {
        setLoader(false);
        containerEl.innerHTML = '';
        
        if (users.length === 0) {
          containerEl.innerHTML = '<div class="text-center text-muted mt-3">No active users found in this OU.</div>';
          return;
        }

        const checkClass = resolveChecklistClass_(containerId);

        containerEl.innerHTML = `
          <div class="form-check border-bottom pb-2 mb-2">
            <input class="form-check-input" type="checkbox" onchange="toggleAll(this, '.${checkClass}')">
            <label class="form-check-label fw-bold">Select All (${users.length})</label>
          </div>
        `;

        users.forEach(u => {
          containerEl.innerHTML += `
            <div class="form-check">
              <input class="form-check-input ${checkClass}" type="checkbox" value="${u.email}" id="${checkClass}_${u.email}">
              <label class="form-check-label small" for="${checkClass}_${u.email}">
                ${u.name} <span class="text-muted">(${u.email})</span>
              </label>
            </div>
          `;
        });
      }).withFailureHandler(err => {
        setLoader(false);
        alert(err.message);
      }).getFilteredUsers(ou, "ALL", null);
    }

    function enrollCheckedStudents() {
      const courseId = document.getElementById('enrollCourseSelect').value;
      const emails = getCheckedValues('.student-check');
      
      if (!courseId) return alert("Please select a target course.");
      if (emails.length === 0) return alert("Please check at least one student.");
      
      setLoader(true, `Enrolling ${emails.length} students...`);
      google.script.run.withSuccessHandler(res => {
        setLoader(false);
        alert(res.message);
      }).withFailureHandler(err => {
        setLoader(false);
        alert("Enrollment Error: " + err.message);
      }).addStudentsToCourse(courseId, emails);
    }

    // --- GROUP & MEMBER MANAGEMENT FUNCTIONS ---

    function loadGroupsForSelectors() {
      const selectEl = document.getElementById('groupTargetSelect');
      const tbody = document.getElementById('groupTableBody');
      if (!selectEl || !tbody) return;

      setLoader(true, "Loading groups...");
      google.script.run.withSuccessHandler(groups => {
        setLoader(false);
        selectEl.innerHTML = "";
        tbody.innerHTML = "";

        if (!groups || groups.length === 0) {
          selectEl.innerHTML = '<option disabled>No groups found</option>';
          tbody.innerHTML = '<tr><td colspan="3" class="text-center py-3 text-muted">No groups found.</td></tr>';
          return;
        }

        groups.forEach(group => {
          selectEl.innerHTML += `<option value="${group.email}">${group.email}${group.name ? " - " + escapeHtml(group.name) : ""}</option>`;
          tbody.innerHTML += `
            <tr>
              <td><code>${escapeHtml(group.email)}</code></td>
              <td>${escapeHtml(group.name || "-")}</td>
              <td class="text-end">${Number(group.directMembersCount || 0)}</td>
            </tr>
          `;
        });
      }).withFailureHandler(err => {
        setLoader(false);
        tbody.innerHTML = `<tr><td colspan="3" class="text-danger text-center py-3">${escapeHtml(err.message)}</td></tr>`;
        alert("Failed to load groups: " + err.message);
      }).getWorkspaceGroups();
    }

    function uploadBatchGroups() {
      const input = document.getElementById('batchGroupFile');
      const file = input.files && input.files[0];
      if (!file) return alert("Please choose a CSV or TSV file.");

      const lowerName = file.name.toLowerCase();
      if (!(lowerName.endsWith('.csv') || lowerName.endsWith('.tsv'))) {
        return alert("Only CSV or TSV files are supported.");
      }

      const reader = new FileReader();
      reader.onload = evt => {
        const content = evt.target.result || "";
        setLoader(true, `Processing ${file.name}...`);
        google.script.run.withSuccessHandler(result => {
          setLoader(false);
          renderGroupBatchResult(result);
          loadGroupsForSelectors();
        }).withFailureHandler(err => {
          setLoader(false);
          alert("Group batch upload failed: " + err.message);
        }).processBatchGroupUpload(file.name, content);
      };
      reader.onerror = () => alert("Failed to read the selected file.");
      reader.readAsText(file);
    }

    function downloadGroupBatchTemplate(format) {
      setLoader(true, `Preparing ${format.toUpperCase()} template...`);
      google.script.run.withSuccessHandler(res => {
        setLoader(false);
        const blob = new Blob([res.content], { type: res.mimeType || "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = res.filename || `workspace-group-batch-template.${format}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }).withFailureHandler(err => {
        setLoader(false);
        alert("Template download failed: " + err.message);
      }).getGroupBatchTemplate(format);
    }

    function renderGroupBatchResult(result) {
      const el = document.getElementById('batchGroupResult');
      if (!el || !result) return;

      const summary = result.summary || {};
      const statusClass = summary.errors ? "alert-warning" : "alert-success";
      const createdHtml = (result.created || []).length
        ? `<div class="mt-2"><strong>Created (${result.created.length})</strong><ul class="mb-0 ps-3 batch-result-scroll">${result.created.map(item => `<li>Row ${item.rowNumber}: ${escapeHtml(item.email)}${item.name ? " (" + escapeHtml(item.name) + ")" : ""}</li>`).join("")}</ul></div>`
        : "";
      const skippedHtml = (result.skipped || []).length
        ? `<div class="mt-2"><strong>Skipped (${result.skipped.length})</strong><ul class="mb-0 ps-3 batch-result-scroll">${result.skipped.map(item => `<li>Row ${item.rowNumber}: ${escapeHtml(item.reason)}</li>`).join("")}</ul></div>`
        : "";
      const errorsHtml = (result.errors || []).length
        ? `<div class="mt-2"><strong>Errors (${result.errors.length})</strong><ul class="mb-0 ps-3 batch-result-scroll">${result.errors.map(item => `<li>Row ${item.rowNumber}: ${escapeHtml(item.message)}</li>`).join("")}</ul></div>`
        : "";

      el.innerHTML = `
        <div class="alert ${statusClass} mb-0">
          <div><strong>Job ID:</strong> <code>${escapeHtml(result.jobId || "-")}</code></div>
          <div><strong>File:</strong> ${escapeHtml(result.fileName || "upload")}</div>
          <div><strong>Mode:</strong> ${escapeHtml(result.delimiter || "")}</div>
          <div><strong>Rows:</strong> ${summary.totalRows || 0} | Attempted: ${summary.attemptedRows || 0} | Created: ${summary.created || 0} | Skipped: ${summary.skipped || 0} | Errors: ${summary.errors || 0}</div>
          ${createdHtml}
          ${skippedHtml}
          ${errorsHtml}
        </div>
      `;
    }

    function assignSelectedMembersToGroups() {
      const groupSelect = document.getElementById('groupTargetSelect');
      const groupEmails = Array.from(groupSelect.selectedOptions || []).map(option => option.value);
      const memberEmails = getCheckedValues('.group-member-check');
      const role = document.getElementById('groupMemberRole').value;
      const sourceOu = document.getElementById('groupMemberOuSelect').value || "";

      if (groupEmails.length === 0) return alert("Please select at least one target group.");
      if (memberEmails.length === 0) return alert("Please select at least one user from OU.");

      if (!confirm(`Assign ${memberEmails.length} users to ${groupEmails.length} groups as ${role}?`)) return;

      setLoader(true, `Assigning ${memberEmails.length * groupEmails.length} memberships...`);
      google.script.run.withSuccessHandler(result => {
        setLoader(false);
        renderGroupMemberAssignResult(result);
        loadGroupsForSelectors();
      }).withFailureHandler(err => {
        setLoader(false);
        alert("Member assignment failed: " + err.message);
      }).assignMembersToGroups({
        groupEmails: groupEmails,
        memberEmails: memberEmails,
        role: role,
        sourceOu: sourceOu
      });
    }

    function renderGroupMemberAssignResult(result) {
      const el = document.getElementById('groupMemberAssignResult');
      if (!el || !result) return;

      const summary = result.summary || {};
      const statusClass = summary.errors ? "alert-warning" : "alert-success";
      const skippedHtml = (result.skipped || []).length
        ? `<div class="mt-2"><strong>Skipped (${result.skipped.length})</strong><ul class="mb-0 ps-3 batch-result-scroll">${result.skipped.slice(0, 20).map(item => `<li>${escapeHtml(item.groupEmail)} <- ${escapeHtml(item.memberEmail)} (${escapeHtml(item.reason || "Skipped")})</li>`).join("")}</ul></div>`
        : "";
      const errorsHtml = (result.errors || []).length
        ? `<div class="mt-2"><strong>Errors (${result.errors.length})</strong><ul class="mb-0 ps-3 batch-result-scroll">${result.errors.slice(0, 20).map(item => `<li>${escapeHtml(item.groupEmail)} <- ${escapeHtml(item.memberEmail)}: ${escapeHtml(item.message)}</li>`).join("")}</ul></div>`
        : "";

      el.innerHTML = `
        <div class="alert ${statusClass} mb-0">
          <div><strong>Job ID:</strong> <code>${escapeHtml(result.jobId || "-")}</code></div>
          <div><strong>Role:</strong> ${escapeHtml(result.role || "-")}</div>
          <div><strong>Assignments:</strong> ${summary.totalAssignments || 0} | Added: ${summary.added || 0} | Skipped: ${summary.skipped || 0} | Errors: ${summary.errors || 0}</div>
          ${skippedHtml}
          ${errorsHtml}
        </div>
      `;
    }

    // --- USER MANAGEMENT FUNCTIONS ---

    function toggleDatePicker() {
      const status = document.getElementById('loginStatusSelect').value;
      document.getElementById('filterDate').disabled = (status !== 'BEFORE_DATE');
    }

    function filterUsers() {
      const ou = document.getElementById('ouSelect').value;
      const condition = document.getElementById('loginStatusSelect').value;
      const date = document.getElementById('filterDate').value;
      
      if (!ou) return alert("Please select an OU.");
      if (condition === 'BEFORE_DATE' && !date) return alert("Please select a date.");
      
      setLoader(true, "Searching Directory...");
      google.script.run.withSuccessHandler(users => {
        setLoader(false);
        document.getElementById('userCount').innerText = users.length;
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';
        
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3">No users found.</td></tr>';
          return;
        }

        users.forEach(u => {
          const badge = u.suspended 
            ? '<span class="badge bg-danger">Suspended</span>' 
            : '<span class="badge bg-success">Active</span>';
            
          tbody.innerHTML += `
            <tr>
              <td><input type="checkbox" class="user-check" value="${u.email}"></td>
              <td>${u.name}</td>
              <td>${u.email}</td>
              <td>${u.lastLogin}</td>
              <td>${badge}</td>
              <td><small class="text-muted">${u.org}</small></td>
            </tr>`;
        });
      }).withFailureHandler(err => {
        setLoader(false);
        alert("Search Failed: " + err.message);
      }).getFilteredUsers(ou, condition, date);
    }

    function suspendSelected() {
      const emails = getCheckedValues('.user-check');
      if (emails.length === 0) return alert("No users selected.");
      
      if (!confirm(`WARNING: Suspend ${emails.length} users?\nThey will be queued for deletion in 3 months.`)) return;
      
      setLoader(true, "Suspending & Queuing...");
      google.script.run.withSuccessHandler(msg => {
        setLoader(false);
        alert(msg);
        filterUsers();
      }).processUserSuspension(emails);
    }

    function bulkMoveUsers() {
      const emails = getCheckedValues('.user-check');
      const targetOU = document.getElementById('targetOuSelect').value;

      if (emails.length === 0) return alert("Please select users to move.");
      if (!targetOU) return alert("Please select a Target OU from the dropdown.");

      if (!confirm(`Confirm move ${emails.length} users to:\n${targetOU}`)) return;

      setLoader(true, "Moving Users...");
      google.script.run.withSuccessHandler(res => {
        setLoader(false);
        alert(res.message);
        filterUsers();
      }).withFailureHandler(err => {
        setLoader(false);
        alert("Move Failed: " + err.message);
      }).moveUsersToOU(emails, targetOU);
    }

    function syncSuspended() {
      setLoader(true, "Syncing...");
      google.script.run.withSuccessHandler(msg => {
        setLoader(false);
        alert(msg);
      }).syncSuspendedToQueue();
    }

    function installTrigger() {
      setLoader(true, "Installing Trigger...");
      google.script.run.withSuccessHandler(msg => {
        setLoader(false);
        alert(msg);
      }).installTrigger();
    }

    // --- DRIVE AUDIT FUNCTIONS ---

    function auditDrive() {
      const dateStr = document.getElementById('driveFilterDate').value;
      if (!dateStr) return alert("Please select a date.");
      
      setLoader(true, "Auditing Drive (This may take a while)...");
      google.script.run.withSuccessHandler(files => {
        setLoader(false);
        const tbody = document.getElementById('driveTableBody');
        tbody.innerHTML = '';
        
        if (files.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3">No outdated files found.</td></tr>';
          return;
        }

        files.forEach(f => {
          const icon = f.isFolder ? '<i class="bi bi-folder-fill text-warning"></i>' : '<i class="bi bi-file-earmark-text"></i>';
          tbody.innerHTML += `
            <tr>
              <td><input type="checkbox" class="file-check" value="${f.id}"></td>
              <td>${icon} <a href="${f.link}" target="_blank" class="text-decoration-none">${f.name}</a></td>
              <td><small>${f.owner}</small></td>
              <td>${f.modified}</td>
              <td>${f.size}</td>
              <td>${f.isFolder ? 'Folder' : 'File'}</td>
            </tr>`;
        });
      }).withFailureHandler(err => {
        setLoader(false);
        alert("Audit Failed: " + err.message);
      }).findOutdatedFiles(dateStr); // Fixed sort
    }

    function manageFiles(action) {
      const ids = getCheckedValues('.file-check');
      if (ids.length === 0) return alert("Please select files first.");
      
      const confirmMsg = action === 'delete' 
        ? `PERMANENTLY DELETE ${ids.length} items?` 
        : `Archive (Rename) ${ids.length} items?`;
        
      if (!confirm(confirmMsg)) return;

      setLoader(true, `${action === 'delete' ? 'Deleting' : 'Archiving'} items...`);
      google.script.run.withSuccessHandler(msg => {
        setLoader(false);
        alert(msg);
        auditDrive(); // Refresh list
      }).withFailureHandler(err => {
        setLoader(false);
        alert("Operation Failed: " + err.message);
      }).manageFiles(ids, action);
    }

    function runConnectivityTest() {
      setLoader(true, "Testing...");
      google.script.run.withSuccessHandler(msg => {
        setLoader(false);
        alert(msg);
      }).withFailureHandler(err => {
        setLoader(false);
        alert("Connection Error: " + err.message);
      }).testApiConnection();
    }

    // --- FEATURE 6: EMAIL FUNCTIONS ---

    function insertAtCursor(text) {
        const myField = document.getElementById("emailBody");
        if (document.selection) {
            myField.focus();
            sel = document.selection.createRange();
            sel.text = text;
        } else if (myField.selectionStart || myField.selectionStart == '0') {
            var startPos = myField.selectionStart;
            var endPos = myField.selectionEnd;
            myField.value = myField.value.substring(0, startPos)
                + text
                + myField.value.substring(endPos, myField.value.length);
        } else {
            myField.value += text;
        }
    }

    function sendBatchEmail() {
        const recipients = getCheckedValues('.email-check');
        const subject = document.getElementById('emailSubject').value;
        const body = document.getElementById('emailBody').value;

        if (recipients.length === 0) return alert("Please select at least one recipient.");
        if (!subject.trim()) return alert("Subject cannot be empty.");
        if (!body.trim()) return alert("Email body cannot be empty.");

        if (!confirm(`Ready to send email to ${recipients.length} users?`)) return;

        setLoader(true, `Sending ${recipients.length} emails...`);
        
        google.script.run.withSuccessHandler(res => {
            setLoader(false);
            alert(res.message);
        }).withFailureHandler(err => {
            setLoader(false);
            alert("Email Error: " + err.message);
        }).sendCustomEmailBatch(recipients, subject, body);
    }
  </script>
</body>
</html>
