# 班級管理系統 v1.1.0 - 部署指南

## 📋 版本資訊

- **版本號**：v1.1.0
- **發布日期**：2025-11-29
- **更新內容**：
  - ✅ 整合 tc-api 校務系統 API
  - ✅ 新增教師-班級選擇功能
  - ✅ 強化點名系統，支援多班級管理
  - ✅ 即時出席統計圖表（使用 Chart.js）
  - ✅ 資料同步管理頁面

---

## 🎯 新功能概覽

### 1. tc-api 整合

從校務系統 API 自動同步：
- 教師資料（含導師資訊與任教班級）
- 班級資料（年級、班序、班名）
- 學生資料（學號、姓名、性別、座號等）

### 2. 多班級點名系統

- 年級選擇器：選擇要點名的年級
- 班級選擇器：顯示該年級所有班級
- 視覺化學生卡片：快速點選出席狀態
- 即時記錄統計：顯示已記錄/總人數

### 3. 即時出席儀表板

- 各班級出席率圓餅圖
- 即時更新統計數據
- 自動計算出席率百分比
- 支援自動刷新

### 4. 資料同步管理

- 一鍵同步 tc-api 資料
- 即時同步日誌顯示
- 資料數量統計
- 連線狀態檢查

---

## 🚀 快速部署（45 分鐘）

### 步驟 1：準備 tc-api 環境（10 分鐘）

#### 1.1 確認 tc-api 伺服器

確保 tc-api 後端服務已啟動：

```bash
# 進入 tc-api 目錄
cd /path/to/tc-api

# 啟動後端
node backend/app.js
```

預設位址：`http://localhost:3001/api`

#### 1.2 測試 API 連線

使用瀏覽器或 curl 測試：

```bash
# 測試教師列表
curl http://localhost:3001/api/teachers

# 測試班級列表
curl http://localhost:3001/api/classes

# 測試學生列表
curl http://localhost:3001/api/students?grade=7&class_seq=1
```

### 步驟 2：建立 Google Apps Script 專案（15 分鐘）

#### 2.1 建立新的 Google 試算表

1. 前往 Google Drive
2. 新增 → Google 試算表
3. 命名為「班級管理系統 v1.1.0」

#### 2.2 開啟 Apps Script 編輯器

1. 在試算表中，點選「擴充功能」→「Apps Script」
2. 刪除預設的 `Code.gs` 內容

#### 2.3 建立 .gs 檔案

建立以下檔案並貼上對應程式碼：

1. **Config_v1.1.0.gs**
   - 從 `classManage/code/Config_v1.1.0.gs` 複製內容
   - **重要**：修改 `CONFIG.TC_API.BASE_URL` 為您的 tc-api 位址

```javascript
TC_API: {
  BASE_URL: 'http://your-server:3001/api',  // ← 修改這裡
  ...
}
```

2. **WebApp_v1.1.0.gs**
   - 從 `classManage/code/WebApp_v1.1.0.gs` 複製內容

### 步驟 3：建立 HTML 檔案（10 分鐘）

在 Apps Script 編輯器中建立以下 HTML 檔案：

1. **Common_v1.0.0.html**
   - 從 `classManage/html/Common_v1.0.0.html` 複製

2. **Dashboard_v1.1.0.html**
   - 從 `classManage/html/Dashboard_v1.1.0.html` 複製

3. **Attendance_v1.1.0.html**
   - 從 `classManage/html/Attendance_v1.1.0.html` 複製

4. **Sync_v1.1.0.html**
   - 從 `classManage/html/Sync_v1.1.0.html` 複製

5. **ErrorPages_v1.0.0.html**
   - 從 `classManage/html/ErrorPages_v1.0.0.html` 複製（如有）

### 步驟 4：部署 Web App（5 分鐘）

#### 4.1 設定部署

1. 點選「部署」→「新增部署」
2. 選擇類型：**Web 應用程式**
3. 設定：
   - **說明**：班級管理系統 v1.1.0 with tc-api
   - **執行身分**：我
   - **具有存取權的使用者**：任何人（如需限制，選擇「僅限網域內的使用者」）
4. 點選「部署」

#### 4.2 授權

1. 點選「授權存取」
2. 選擇您的 Google 帳號
3. 點選「進階」→「前往...（不安全）」
4. 點選「允許」

#### 4.3 複製 Web App URL

部署完成後，複製 Web 應用程式 URL，格式類似：

```
https://script.google.com/macros/s/AKfy...xxxxx/exec
```

### 步驟 5：首次同步資料（5 分鐘）

#### 5.1 開啟 Web App

在瀏覽器中開啟剛複製的 URL

#### 5.2 前往同步頁面

點選導航列的「同步」按鈕

#### 5.3 執行同步

1. 確認 API 位址正確
2. 點選「開始同步資料」
3. 等待同步完成（約 30 秒 - 2 分鐘）

#### 5.4 驗證資料

同步完成後，檢查試算表是否建立以下工作表：
- 教師資料
- 班級資料
- 班級學生對照
- 系統設定

---

## ⚙️ 進階設定

### 修改 tc-api 連線設定

在 `Config_v1.1.0.gs` 中修改：

```javascript
TC_API: {
  BASE_URL: 'http://your-domain:3001/api',  // API 伺服器位址
  ENDPOINTS: {
    SYNC: '/sync-school',
    STUDENTS: '/students',
    TEACHERS: '/teachers',
    CLASSES: '/classes',
    SEMESTER_DATA: '/semester-data'
  },
  SYNC_INTERVAL: 3600000,   // 同步間隔（毫秒）
  CACHE_DURATION: 1800,      // 快取時間（秒）
  TIMEOUT: 30000             // 請求逾時（毫秒）
}
```

### 設定安全性

#### 啟用網域限制

在 `Config_v1.1.0.gs` 中：

```javascript
SECURITY: {
  ENABLE_AUTH: true,
  ALLOWED_DOMAINS: ['your-school.edu.tw'],  // 允許的 Email 網域
  MAX_LOGIN_ATTEMPTS: 5,
  SESSION_COOKIE_NAME: 'class_mgmt_session'
}
```

#### 設定教師資訊

在試算表的「系統設定」工作表中新增：

| 設定項目 | 設定值 | 說明 |
|---------|--------|------|
| 導師姓名 | 王老師 | 您的姓名 |
| 導師Email | teacher@school.edu.tw | 您的 Email |
| 班級名稱 | 701 | 您的班級 |

### 設定自動同步（選用）

使用 Apps Script 觸發條件實現自動同步：

1. 在 Apps Script 編輯器中，點選「觸發條件」（時鐘圖示）
2. 點選「新增觸發條件」
3. 設定：
   - 選擇函式：`syncFromTcApi`
   - 活動來源：時間驅動
   - 時間型觸發條件：每天計時器
   - 時段：上午 6-7 點（或您希望的時間）
4. 儲存

---

## 🎨 使用者操作指南

### 1. 資料同步

**首次使用或資料異動時執行：**

1. 前往「同步」頁面
2. 點選「開始同步資料」
3. 等待同步完成
4. 確認教師、班級、學生數量正確

**建議同步頻率：**
- 開學初：每天 1 次
- 學期中：每週 1-2 次
- 學生異動時：立即手動同步

### 2. 班級點名

**操作流程：**

1. 前往「點名」頁面
2. 選擇年級（例如：7 年級）
3. 選擇班級（例如：701）
4. 系統自動載入該班學生名單
5. 逐一點選學生的出席狀態：
   - ✓ 出席
   - 🏥 病假
   - 📋 事假
   - ❌ 曠課
   - ⏰ 遲到
6. 可選填備註
7. 點選「儲存點名記錄」

**快速操作：**
- 全部出席：一鍵設定所有學生為「出席」
- 清除全部：清除所有選擇，重新點名

### 3. 即時儀表板

**查看統計：**

1. 前往「儀表板」頁面
2. 查看統計卡片：
   - 學生總數
   - 今日缺曠
   - 逾期未交作業
   - 待審核請假
3. 查看各班出席統計圖表：
   - 圓餅圖顯示各班出席狀況
   - 自動計算出席率
   - 顯示詳細數據

**更新資料：**
- 點選「重新整理」按鈕
- 或點選「更新圖表」按鈕（僅更新圖表）
- 系統每 5 分鐘自動更新

---

## 🔧 疑難排解

### 問題 1：無法連線到 tc-api

**錯誤訊息**：`API錯誤: 404` 或 `Connection failed`

**解決方法**：

1. 確認 tc-api 伺服器是否啟動：
```bash
curl http://localhost:3001/api/teachers
```

2. 檢查 `Config_v1.1.0.gs` 中的 `BASE_URL` 設定

3. 如果 tc-api 在遠端伺服器，確保網路可連線

4. 確認防火牆未封鎖 3001 port

### 問題 2：同步失敗

**錯誤訊息**：`同步失敗: ...`

**檢查項目**：

1. **tc-api 伺服器狀態**
   ```bash
   node backend/app.js
   ```

2. **OAuth 設定**（如 tc-api 需要認證）
   - 確認 `.env` 檔案中的憑證正確

3. **資料格式**
   - 檢查 tc-api 回傳的 JSON 格式是否正確

4. **試算表權限**
   - 確認 Apps Script 有寫入試算表的權限

### 問題 3：學生名單為空

**可能原因**：

1. **尚未同步資料**
   - 前往「同步」頁面執行同步

2. **班級篩選錯誤**
   - 確認選擇的年級與班序正確

3. **資料表名稱錯誤**
   - 檢查試算表中是否有「班級學生對照」工作表

### 問題 4：圖表未顯示

**解決方法**：

1. **檢查 Chart.js CDN**
   - 確認網路可連線到 `cdn.jsdelivr.net`

2. **檢查瀏覽器 Console**
   - 按 F12 開啟開發者工具
   - 查看 Console 標籤中的錯誤訊息

3. **清除瀏覽器快取**
   - Ctrl + Shift + Delete
   - 清除快取與 Cookie

### 問題 5：權限不足

**錯誤訊息**：`無權限`

**解決方法**：

1. **檢查 Email 網域**
   - 確認您的 Email 在 `ALLOWED_DOMAINS` 清單中

2. **重新授權**
   - Apps Script 編輯器 → 執行 → 執行函式
   - 選擇 `doGet` → 執行
   - 重新授權

3. **暫時停用驗證**（開發測試用）
   ```javascript
   SECURITY: {
     ENABLE_AUTH: false,  // 停用驗證
     ...
   }
   ```

---

## 📊 資料結構

### 教師資料表

| 欄位 | 說明 | 範例 |
|-----|------|------|
| UID | 教師唯一識別碼 | T001 |
| UID2 | 備用識別碼 | T001 |
| 姓名 | 教師姓名 | 王小明 |
| 處室 | 所屬處室 | 教務處 |
| 職稱 | 職稱 | 教師 |
| 是否導師 | 導師標記 | 是 |
| Email | Email | teacher@school.edu.tw |
| 任教班級 | 任教班級列表 | 7-1, 7-2 |

### 班級資料表

| 欄位 | 說明 | 範例 |
|-----|------|------|
| 年級 | 年級 | 7 |
| 班序 | 班序 | 1 |
| 班名 | 班級名稱 | 701 |

### 班級學生對照表

| 欄位 | 說明 | 範例 |
|-----|------|------|
| 學號 | 學號 | 20230001 |
| 姓名 | 學生姓名 | 李小華 |
| 性別 | 性別 | 女 |
| 年級 | 年級 | 7 |
| 班名 | 班級名稱 | 701 |
| 班序 | 班序 | 1 |
| 座號 | 座號 | 5 |

### 缺曠記錄表

| 欄位 | 說明 | 範例 |
|-----|------|------|
| 日期 | 點名日期 | 2025-11-29 |
| 座號 | 座號 | 5 |
| 姓名 | 學生姓名 | 李小華 |
| 狀態 | 出席狀態 | 出席 |
| 記錄時間 | 記錄時間 | 2025-11-29 08:30:00 |
| 記錄者 | 記錄者 Email | teacher@school.edu.tw |
| 備註 | 備註 | - |
| 年級 | 年級 | 7 |
| 班序 | 班序 | 1 |

---

## 🔄 版本更新

### 從 v1.0.0 升級到 v1.1.0

#### 升級步驟：

1. **備份現有資料**
   - 複製整個試算表作為備份

2. **更新 .gs 檔案**
   - 建立 `Config_v1.1.0.gs`（或覆蓋 v1.0.0）
   - 建立 `WebApp_v1.1.0.gs`（或覆蓋 v1.0.0）

3. **新增 HTML 檔案**
   - 建立 `Dashboard_v1.1.0.html`
   - 建立 `Attendance_v1.1.0.html`
   - 建立 `Sync_v1.1.0.html`

4. **重新部署**
   - 部署 → 管理部署
   - 選擇現有部署 → 編輯
   - 更新版本為 v1.1.0
   - 部署

5. **執行首次同步**
   - 前往「同步」頁面
   - 執行資料同步

#### 資料遷移：

如果您有現有的學生資料（在「學生基本資料」工作表）：

- 資料將保留，不會被覆蓋
- 新同步的資料會建立在「班級學生對照」工作表
- 建議逐步遷移至新結構

---

## 📞 技術支援

### 聯絡資訊

- **Email**: your-email@example.com
- **GitHub Issues**: https://github.com/your-repo/issues

### 文件資源

- **專案總覽**: `01-PROJECT_OVERVIEW.md`
- **版本說明**: `00-VERSION_1.1.0_README.md`
- **檔案清單**: `03-FILE_LIST.md`

---

## 📝 更新日誌

### v1.1.0 (2025-11-29)

**新增功能：**
- ✅ tc-api 整合（教師、班級、學生同步）
- ✅ 多班級點名系統
- ✅ 即時出席統計圖表（Chart.js）
- ✅ 資料同步管理頁面
- ✅ 年級-班級選擇器
- ✅ 視覺化學生點名卡片
- ✅ 自動同步機制（可設定）

**改進：**
- 🔧 優化點名操作流程
- 🔧 增強快取機制
- 🔧 改進錯誤處理
- 🔧 響應式設計優化

**修復：**
- 🐛 修正時區問題（統一 UTC+8）
- 🐛 修正資料載入快取問題

### v1.0.0 (2025-11-18)

**初始版本：**
- ✅ 基本點名功能
- ✅ 作業管理
- ✅ 請假管理
- ✅ 學生管理
- ✅ 儀表板

---

**部署完成後，請前往「同步」頁面執行首次資料同步！**

**祝您使用愉快！** 🎉

