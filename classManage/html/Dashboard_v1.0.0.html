<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><?= teacherInfo.className ?> - 班級管理系統</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  
  <?!= include('Common_v1.0.0'); ?>
</head>
<body>
  <!-- 導航列 -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="?page=dashboard" class="navbar-brand">
        <i class="fas fa-school"></i>
        <span><?= teacherInfo.className ?> 班級管理</span>
      </a>
      
      <button class="navbar-toggle" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul class="navbar-menu">
        <li><a href="?page=dashboard" class="active"><i class="fas fa-home"></i> 儀表板</a></li>
        <li><a href="?page=attendance"><i class="fas fa-check-square"></i> 點名</a></li>
        <li><a href="?page=homework"><i class="fas fa-book"></i> 作業</a></li>
        <li><a href="?page=leave"><i class="fas fa-file-alt"></i> 請假</a></li>
        <li><a href="?page=students"><i class="fas fa-users"></i> 學生</a></li>
      </ul>
      
      <div class="navbar-user">
        <i class="fas fa-user-circle"></i>
        <span><?= teacherInfo.name ?></span>
      </div>
    </div>
  </nav>
  
  <!-- 主要內容 -->
  <div class="container">
    <!-- 頁面標題 -->
    <div class="card">
      <div class="card-header">
        <div>
          <h1 class="card-title">
            <i class="fas fa-chart-line"></i>
            班級總覽
          </h1>
          <p class="text-muted" style="margin-top: 5px; font-size: 14px;">
            歡迎，<?= teacherInfo.name ?> 老師 | 
            <span id="lastUpdate">載入中...</span>
          </p>
        </div>
        <button class="btn btn-primary btn-sm" onclick="refreshDashboard()">
          <i class="fas fa-sync-alt"></i> 重新整理
        </button>
      </div>
    </div>
    
    <!-- 統計卡片 -->
    <div class="stats-grid">
      <div class="stat-card blue">
        <div class="stat-icon"><i class="fas fa-users"></i></div>
        <div class="stat-number" id="totalStudents">-</div>
        <div class="stat-label">學生總數</div>
      </div>
      
      <div class="stat-card red">
        <div class="stat-icon"><i class="fas fa-user-times"></i></div>
        <div class="stat-number" id="todayAbsence">-</div>
        <div class="stat-label">昨日缺曠</div>
      </div>
      
      <div class="stat-card orange">
        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="stat-number" id="overdueHomework">-</div>
        <div class="stat-label">逾期未交作業</div>
      </div>
      
      <div class="stat-card green">
        <div class="stat-icon"><i class="fas fa-clipboard-check"></i></div>
        <div class="stat-number" id="pendingLeaves">-</div>
        <div class="stat-label">待審核請假</div>
      </div>
    </div>
    
    <!-- 班級出席即時圖 -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-chart-bar"></i>
          班級出席即時圖
        </h2>
        <span class="text-muted" id="chartMeta">資料載入中...</span>
      </div>
      <div class="card-body">
        <div id="classAttendanceChart" style="height: 380px;">
          <div class="loading">
            <div class="spinner"></div>
            <p>載入圖表中...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 詳細資訊 -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
      <!-- 昨日缺曠記錄 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-calendar-day"></i>
            昨日缺曠記錄
          </h2>
        </div>
        <div class="card-body">
          <div id="absenceList" style="max-height: 400px; overflow-y: auto;">
            <div class="loading">
              <div class="spinner"></div>
              <p>載入中...</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 逾期未交作業 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-exclamation-triangle"></i>
            逾期未交作業
          </h2>
        </div>
        <div class="card-body">
          <div id="homeworkList" style="max-height: 400px; overflow-y: auto;">
            <div class="loading">
              <div class="spinner"></div>
              <p>載入中...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 待審核請假單 -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-file-alt"></i>
          待審核請假單
        </h2>
      </div>
      <div class="card-body">
        <div id="leaveList">
          <div class="loading">
            <div class="spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 頁尾 -->
    <div style="text-align: center; margin-top: 30px; padding: 20px; color: var(--text-muted); font-size: 13px;">
      <p>班級管理系統 v<?= version ?> | 
        UTC+8 時區 | 
        <span id="currentTime"></span>
      </p>
    </div>
  </div>
  
  <script>
    // 全域變數
    let dashboardData = null;
    let chartsReady = false;
    
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(function() {
      chartsReady = true;
      if (dashboardData && dashboardData.classAttendance) {
        renderClassAttendanceChart(dashboardData.classAttendance);
      }
    });
    
    // 頁面載入時執行
    window.onload = function() {
      loadDashboardData();
      updateCurrentTime();
      setInterval(updateCurrentTime, 1000);
    };
    
    /**
     * 載入儀表板資料
     */
    function loadDashboardData() {
      showLoading('absenceList');
      showLoading('homeworkList');
      showLoading('leaveList');
      showLoadingChart();
      
      google.script.run
        .withSuccessHandler(onDataLoaded)
        .withFailureHandler(onDataError)
        .getDashboardData();
    }
    
    /**
     * 資料載入成功
     */
    function onDataLoaded(data) {
      if (data.error) {
        showError('absenceList', data.error);
        showError('homeworkList', data.error);
        showError('leaveList', data.error);
        return;
      }
      
      dashboardData = data;
      
      // 更新統計數字
      document.getElementById('totalStudents').textContent = data.summary.totalStudents;
      document.getElementById('todayAbsence').textContent = data.summary.todayAbsence;
      document.getElementById('overdueHomework').textContent = data.summary.overdueHomework;
      document.getElementById('pendingLeaves').textContent = data.summary.pendingLeaves;
      document.getElementById('lastUpdate').textContent = '更新時間：' + data.lastUpdate;
      
      // 更新各個清單
      renderAbsenceList(data.absenceList);
      renderHomeworkList(data.homeworkList);
      renderLeaveList(data.leaveList);
      
      if (data.classAttendance) {
        renderClassAttendanceChart(data.classAttendance);
      } else {
        renderClassAttendanceChart(null);
      }
    }
    
    /**
     * 資料載入失敗
     */
    function onDataError(error) {
      console.error('載入資料失敗:', error);
      showError('absenceList', '載入失敗：' + error);
      showError('homeworkList', '載入失敗：' + error);
      showError('leaveList', '載入失敗：' + error);
      showError('classAttendanceChart', '載入失敗：' + error);
      const chartMeta = document.getElementById('chartMeta');
      if (chartMeta) {
        chartMeta.textContent = '載入失敗';
      }
    }
    
    /**
     * 渲染缺曠記錄清單
     */
    function renderAbsenceList(list) {
      const container = document.getElementById('absenceList');
      
      if (!list || list.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <p>全班出席，無缺曠記錄</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      list.forEach(item => {
        const badgeClass = item.status === '曠課' ? 'badge-danger' : 
                          item.status === '病假' ? 'badge-warning' : 'badge-info';
        
        html += `
          <div style="padding: 12px; border-left: 4px solid var(--primary-color); background: #f8f9ff; margin-bottom: 10px; border-radius: 6px;">
            <div style="font-weight: 600; margin-bottom: 4px;">
              ${item.name} <span class="badge ${badgeClass}">${item.status}</span>
            </div>
            <div style="font-size: 13px; color: var(--text-light);">
              座號：${item.seatNumber}
              ${item.notes ? ' | 備註：' + item.notes : ''}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    /**
     * 渲染作業清單
     */
    function renderHomeworkList(list) {
      const container = document.getElementById('homeworkList');
      
      if (!list || list.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <p>無逾期未交作業</p>
          </div>
        `;
        return;
      }
      
      // 依學生分組
      const grouped = {};
      list.forEach(item => {
        const key = `${item.seatNumber}-${item.studentName}`;
        if (!grouped[key]) {
          grouped[key] = {
            seatNumber: item.seatNumber,
            studentName: item.studentName,
            homeworks: []
          };
        }
        grouped[key].homeworks.push(`${item.subject} - ${item.homeworkName}`);
      });
      
      let html = '';
      Object.values(grouped).forEach(student => {
        html += `
          <div style="padding: 12px; border-left: 4px solid var(--warning-color); background: #fff8e1; margin-bottom: 10px; border-radius: 6px;">
            <div style="font-weight: 600; margin-bottom: 4px;">
              ${student.studentName} 
              <span class="badge badge-danger">${student.homeworks.length} 項</span>
            </div>
            <div style="font-size: 13px; color: var(--text-light);">
              座號：${student.seatNumber}<br>
              未交作業：${student.homeworks.join('、')}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    /**
     * 渲染請假清單
     */
    function renderLeaveList(list) {
      const container = document.getElementById('leaveList');
      
      if (!list || list.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <p>無待審核請假單</p>
          </div>
        `;
        return;
      }
      
      let html = '<div class="table-container"><table>';
      html += `
        <thead>
          <tr>
            <th>學生</th>
            <th>座號</th>
            <th>請假日期</th>
            <th>類型</th>
            <th>原因</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
      `;
      
      list.forEach(item => {
        html += `
          <tr>
            <td>${item.studentName}</td>
            <td>${item.seatNumber || '-'}</td>
            <td>${item.leaveDate}</td>
            <td><span class="badge badge-info">${item.leaveType}</span></td>
            <td>${item.reason}</td>
            <td>
              <button class="btn btn-success btn-sm" onclick="approveLeave(${item.rowIndex}, '已核准')">
                <i class="fas fa-check"></i> 核准
              </button>
              <button class="btn btn-danger btn-sm" onclick="approveLeave(${item.rowIndex}, '已拒絕')">
                <i class="fas fa-times"></i> 拒絕
              </button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }
    
    /**
     * 審核請假
     */
    function approveLeave(rowIndex, approvalStatus) {
      const action = approvalStatus === '已核准' ? '核准' : '拒絕';
      
      if (!confirmAction(`確定要${action}這筆請假申請嗎？`)) {
        return;
      }
      
      showLoading('leaveList');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess(result.message);
            loadDashboardData();
          } else {
            showError('leaveList', result.error);
          }
        })
        .withFailureHandler(function(error) {
          showError('leaveList', error);
        })
        .handleApproveLeave({
          rowIndex: rowIndex,
          approvalStatus: approvalStatus,
          notes: ''
        });
    }
    
    /**
     * 重新整理儀表板
     */
    function refreshDashboard() {
      loadDashboardData();
      showSuccess('資料已更新');
    }
    
    /**
     * 更新當前時間
     */
    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleString('zh-TW', { 
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      const element = document.getElementById('currentTime');
      if (element) {
        element.textContent = timeString;
      }
    }
    
    /**
     * 顯示圖表載入動畫
     */
    function showLoadingChart() {
      const container = document.getElementById('classAttendanceChart');
      if (container) {
        container.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p>載入圖表中...</p>
          </div>
        `;
      }
      const chartMeta = document.getElementById('chartMeta');
      if (chartMeta) {
        chartMeta.textContent = '資料載入中...';
      }
    }
    
    /**
     * 渲染班級出席圖表
     */
    function renderClassAttendanceChart(chartData) {
      const container = document.getElementById('classAttendanceChart');
      const chartMeta = document.getElementById('chartMeta');
      if (!container) return;
      
      if (chartData && chartData.error) {
        showError('classAttendanceChart', chartData.error);
        if (chartMeta) {
          chartMeta.textContent = '載入失敗';
        }
        return;
      }
      
      if (!chartData || !chartData.classes || chartData.classes.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-chart-line"></i>
            <p>尚無今日出席統計</p>
          </div>
        `;
        if (chartMeta) {
          chartMeta.textContent = '尚無統計資料';
        }
        return;
      }
      
      if (chartMeta) {
        const dateLabel = (chartData.metadata && chartData.metadata.targetDate) ? chartData.metadata.targetDate : '今日';
        chartMeta.textContent = `${dateLabel} ｜ ${chartData.classes.length} 個班級`;
      }
      
      if (!chartsReady) {
        showLoadingChart();
        return;
      }
      
      const dataTable = new google.visualization.DataTable();
      dataTable.addColumn('string', '班級');
      dataTable.addColumn('number', '出席');
      dataTable.addColumn('number', '缺席/請假');
      dataTable.addColumn('number', '未記錄');
      
      chartData.classes.forEach(cls => {
        dataTable.addRow([
          cls.displayName || `${cls.grade}年${cls.className}`,
          Number(cls.presentCount || 0),
          Number(cls.absentCount || 0),
          Number(cls.unmarkedCount || 0)
        ]);
      });
      
      const options = {
        isStacked: true,
        height: 360,
        legend: { position: 'top' },
        colors: ['#4caf50', '#f44336', '#90a4ae'],
        vAxis: { minValue: 0, title: '學生數' },
        hAxis: { title: '班級' },
        chartArea: { width: '80%', height: '70%' },
        bar: { groupWidth: '60%' }
      };
      
      const chart = new google.visualization.ColumnChart(container);
      chart.draw(dataTable, options);
    }
  </script>
  
  <!-- 響應式調整 -->
  <style>
    @media (max-width: 1024px) {
      div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
</body>
</html>
