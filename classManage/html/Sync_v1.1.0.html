<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>資料同步 - 班級管理系統</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <?!= include('Common_v1.0.0'); ?>
  
  <style>
    .sync-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .sync-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      text-align: center;
      transition: transform 0.3s ease;
    }
    
    .sync-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    
    .sync-icon {
      font-size: 48px;
      margin-bottom: 15px;
      color: #667eea;
    }
    
    .sync-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #333;
    }
    
    .sync-desc {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .sync-status {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      display: inline-block;
      margin-bottom: 15px;
    }
    
    .sync-status.success {
      background: #d4edda;
      color: #155724;
    }
    
    .sync-status.warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .sync-status.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .log-container {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      text-align: left;
      line-height: 1.6;
    }
    
    .log-entry {
      margin-bottom: 8px;
    }
    
    .log-timestamp {
      color: #808080;
    }
    
    .log-info {
      color: #4ec9b0;
    }
    
    .log-success {
      color: #4caf50;
    }
    
    .log-error {
      color: #f44336;
    }
    
    .config-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .config-item {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
    }
    
    .config-label {
      font-weight: 600;
      color: #333;
    }
    
    .config-value {
      padding: 10px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      font-family: monospace;
      font-size: 13px;
    }
    
    @media (max-width: 768px) {
      .config-item {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- 導航列 -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="?page=dashboard" class="navbar-brand">
        <i class="fas fa-school"></i>
        <span>班級管理系統</span>
      </a>
      
      <button class="navbar-toggle" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul class="navbar-menu">
        <li><a href="?page=dashboard"><i class="fas fa-home"></i> 儀表板</a></li>
        <li><a href="?page=attendance"><i class="fas fa-check-square"></i> 點名</a></li>
        <li><a href="?page=homework"><i class="fas fa-book"></i> 作業</a></li>
        <li><a href="?page=leave"><i class="fas fa-file-alt"></i> 請假</a></li>
        <li><a href="?page=students"><i class="fas fa-users"></i> 學生</a></li>
        <li><a href="?page=sync" class="active"><i class="fas fa-sync"></i> 同步</a></li>
      </ul>
      
      <div class="navbar-user">
        <i class="fas fa-user-circle"></i>
        <span><?= userEmail ?></span>
      </div>
    </div>
  </nav>
  
  <!-- 主要內容 -->
  <div class="container">
    <!-- 頁面標題 -->
    <div class="card">
      <div class="card-header">
        <div>
          <h1 class="card-title">
            <i class="fas fa-sync-alt"></i>
            資料同步管理
          </h1>
          <p class="text-muted" style="margin-top: 5px; font-size: 14px;">
            使用 OAuth 2.0 從臺中市校務系統同步教師、班級與學生資料
          </p>
        </div>
      </div>
    </div>
    
    <!-- tc-api 設定資訊 -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-cog"></i>
          OAuth 2.0 連線設定
        </h2>
      </div>
      <div class="card-body">
        <div class="config-section">
          <div class="config-item">
            <div class="config-label">OAuth Token URL：</div>
            <div class="config-value" id="oauthTokenUrl">載入中...</div>
          </div>
          <div class="config-item">
            <div class="config-label">校務 API 位址：</div>
            <div class="config-value" id="schoolApiUrl">載入中...</div>
          </div>
          <div class="config-item">
            <div class="config-label">上次同步時間：</div>
            <div class="config-value" id="lastSync">從未同步</div>
          </div>
          <div class="config-item">
            <div class="config-label">系統版本：</div>
            <div class="config-value"><?= version ?></div>
          </div>
        </div>
        
        <div style="text-align: center;">
          <button class="btn btn-secondary btn-sm" onclick="loadSystemStatus()">
            <i class="fas fa-info-circle"></i> 檢查系統狀態
          </button>
        </div>
      </div>
    </div>
    
    <!-- 同步操作 -->
    <div class="sync-section">
      <!-- 教師資料 -->
      <div class="sync-card">
        <div class="sync-icon">
          <i class="fas fa-chalkboard-teacher"></i>
        </div>
        <div class="sync-title">教師資料</div>
        <div class="sync-desc">
          從 tc-api 同步所有教師資料，包含導師資訊與任教班級
        </div>
        <div class="sync-status warning" id="teacherStatus">
          <i class="fas fa-clock"></i> 等待同步
        </div>
        <div>
          <span class="text-muted" style="font-size: 13px;">
            教師數量：<span id="teacherCount">-</span>
          </span>
        </div>
      </div>
      
      <!-- 班級資料 -->
      <div class="sync-card">
        <div class="sync-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="sync-title">班級資料</div>
        <div class="sync-desc">
          同步所有年級與班級資訊，建立班級架構
        </div>
        <div class="sync-status warning" id="classStatus">
          <i class="fas fa-clock"></i> 等待同步
        </div>
        <div>
          <span class="text-muted" style="font-size: 13px;">
            班級數量：<span id="classCount">-</span>
          </span>
        </div>
      </div>
      
      <!-- 學生資料 -->
      <div class="sync-card">
        <div class="sync-icon">
          <i class="fas fa-user-graduate"></i>
        </div>
        <div class="sync-title">學生資料</div>
        <div class="sync-desc">
          同步所有學生基本資料與班級對應關係
        </div>
        <div class="sync-status warning" id="studentStatus">
          <i class="fas fa-clock"></i> 等待同步
        </div>
        <div>
          <span class="text-muted" style="font-size: 13px;">
            學生數量：<span id="studentCount">-</span>
          </span>
        </div>
      </div>
    </div>
    
    <!-- 執行同步 -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-play-circle"></i>
          執行同步作業
        </h2>
      </div>
      <div class="card-body">
        <div style="text-align: center; margin-bottom: 20px;">
          <button class="btn btn-primary btn-lg" onclick="startSync()" id="syncBtn">
            <i class="fas fa-sync-alt"></i> 開始同步資料
          </button>
        </div>
        
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <span>
            <strong>同步方式：</strong>
            使用 OAuth 2.0 Client Credentials 流程，直接連接臺中市校務系統 API 取得學期資料。
            同步期間請勿關閉此頁面。
          </span>
        </div>
        
        <!-- 同步日誌 -->
        <div id="logSection" style="display: none; margin-top: 20px;">
          <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">
            <i class="fas fa-terminal"></i> 同步日誌
          </h3>
          <div class="log-container" id="syncLog">
            <!-- Logs will appear here -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- 說明文件 -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-question-circle"></i>
          使用說明
        </h2>
      </div>
      <div class="card-body">
        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">
          什麼是 OAuth 2.0 同步？
        </h3>
        <p style="margin-bottom: 15px; line-height: 1.6;">
          本系統使用 OAuth 2.0 Client Credentials 流程，直接連接臺中市校務系統 API (`https://api.cloudschool.tw`)。
          透過安全的 OAuth 認證機制取得 access token，然後呼叫 `/semester-data` 端點取得學期資料，包含教師、班級與學生等完整資訊。
        </p>
        
        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">
          同步頻率建議
        </h3>
        <ul style="margin-bottom: 15px; padding-left: 20px; line-height: 1.8;">
          <li>開學初：每天同步 1 次</li>
          <li>學期中：每週同步 1-2 次</li>
          <li>學生異動時：立即手動同步</li>
          <li>長假期間：可暫停同步</li>
        </ul>
        
        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">
          故障排除
        </h3>
        <ul style="margin-bottom: 0; padding-left: 20px; line-height: 1.8;">
          <li><strong>OAuth Token 取得失敗</strong>：檢查 Config.gs 中的 OAUTH 設定（CLIENT_ID、CLIENT_SECRET、TOKEN_URL）</li>
          <li><strong>API 呼叫失敗</strong>：確認 SCHOOL_API_URL 設定正確</li>
          <li><strong>資料同步失敗</strong>：查看 GAS 執行記錄（編輯器 → View → Logs）取得詳細錯誤訊息</li>
          <li>確認網路連線狀態正常</li>
          <li>如果同步持續失敗，請稍後重試或聯絡系統管理員</li>
        </ul>
      </div>
    </div>
  </div>
  
  <script>
    let syncInProgress = false;
    
    window.onload = function() {
      loadSystemStatus();
      loadDataCounts();
    };
    
    /**
     * 載入系統狀態
     */
    function loadSystemStatus() {
      google.script.run
        .withSuccessHandler(function(status) {
          // Display API URLs from Config
          document.getElementById('oauthTokenUrl').textContent = status.oauthTokenUrl || '未設定';
          document.getElementById('schoolApiUrl').textContent = status.schoolApiUrl || '未設定';
          document.getElementById('lastSync').textContent = status.lastSync || '從未同步';
          
          // Log to console for debugging
          console.log('System Status:', status);
        })
        .withFailureHandler(function(error) {
          console.error('載入系統狀態失敗:', error);
          document.getElementById('oauthTokenUrl').textContent = '載入失敗';
          document.getElementById('schoolApiUrl').textContent = '載入失敗';
        })
        .getSystemStatus();
    }
    
    /**
     * 載入資料數量統計
     */
    function loadDataCounts() {
      google.script.run
        .withSuccessHandler(function(counts) {
          document.getElementById('teacherCount').textContent = counts.teachers || 0;
          document.getElementById('classCount').textContent = counts.classes || 0;
          document.getElementById('studentCount').textContent = counts.students || 0;
          
          // Update status
          if (counts.teachers > 0) {
            updateStatusBadge('teacherStatus', 'success', '已同步');
          }
          if (counts.classes > 0) {
            updateStatusBadge('classStatus', 'success', '已同步');
          }
          if (counts.students > 0) {
            updateStatusBadge('studentStatus', 'success', '已同步');
          }
        })
        .withFailureHandler(function(error) {
          console.error('載入資料數量失敗:', error);
        })
        .getDataCounts();
    }
    
    /**
     * 更新狀態徽章
     */
    function updateStatusBadge(elementId, status, text) {
      const element = document.getElementById(elementId);
      element.className = `sync-status ${status}`;
      
      const icon = status === 'success' ? 'fa-check-circle' : 
                   status === 'error' ? 'fa-times-circle' : 'fa-clock';
      element.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
    }
    
    /**
     * 開始同步
     */
    function startSync() {
      if (syncInProgress) {
        alert('同步作業進行中，請稍候...');
        return;
      }
      
      if (!confirmAction('確定要開始同步資料嗎？\n\n這將使用 OAuth 2.0 從臺中市校務系統取得最新資料並更新本地試算表。')) {
        return;
      }
      
      syncInProgress = true;
      
      // Update UI
      const syncBtn = document.getElementById('syncBtn');
      syncBtn.disabled = true;
      syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 同步中...';
      
      // Show log section
      document.getElementById('logSection').style.display = 'block';
      
      // Clear log
      const logContainer = document.getElementById('syncLog');
      logContainer.innerHTML = '';
      
      // Add initial log
      addLog('開始 OAuth 2.0 同步作業...', 'info');
      
      // Update status badges
      updateStatusBadge('teacherStatus', 'warning', '同步中...');
      updateStatusBadge('classStatus', 'warning', '同步中...');
      updateStatusBadge('studentStatus', 'warning', '同步中...');
      
      // Call sync function
      google.script.run
        .withSuccessHandler(onSyncComplete)
        .withFailureHandler(onSyncError)
        .syncFromSchoolApi();
    }
    
    /**
     * 同步完成
     */
    function onSyncComplete(result) {
      syncInProgress = false;
      
      const syncBtn = document.getElementById('syncBtn');
      syncBtn.disabled = false;
      syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 開始同步資料';
      
      if (result.success) {
        addLog('同步完成！', 'success');
        
        if (result.學年 && result.學期) {
          addLog(`學年: ${result.學年} 學期: ${result.學期}`, 'success');
        }
        addLog(`教師資料：${result.teachers || 0} 筆`, 'success');
        addLog(`班級資料：${result.classes || 0} 班`, 'success');
        addLog(`學生資料：${result.students || 0} 筆`, 'success');
        
        updateStatusBadge('teacherStatus', 'success', '同步成功');
        updateStatusBadge('classStatus', 'success', '同步成功');
        updateStatusBadge('studentStatus', 'success', '同步成功');
        
        showSuccess('資料同步完成！');
        
        // Reload counts and status
        setTimeout(loadDataCounts, 1000);
        setTimeout(loadSystemStatus, 1000);
      } else {
        addLog('同步失敗：' + result.message, 'error');
        
        updateStatusBadge('teacherStatus', 'error', '同步失敗');
        updateStatusBadge('classStatus', 'error', '同步失敗');
        updateStatusBadge('studentStatus', 'error', '同步失敗');
        
        alert('同步失敗：' + result.message);
      }
    }
    
    /**
     * 同步錯誤
     */
    function onSyncError(error) {
      syncInProgress = false;
      
      const syncBtn = document.getElementById('syncBtn');
      syncBtn.disabled = false;
      syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 開始同步資料';
      
      addLog('發生錯誤：' + error, 'error');
      
      updateStatusBadge('teacherStatus', 'error', '同步失敗');
      updateStatusBadge('classStatus', 'error', '同步失敗');
      updateStatusBadge('studentStatus', 'error', '同步失敗');
      
      alert('同步發生錯誤：' + error);
    }
    
    /**
     * 新增日誌
     */
    function addLog(message, type = 'info') {
      const logContainer = document.getElementById('syncLog');
      const timestamp = new Date().toLocaleTimeString('zh-TW', { hour12: false });
      
      const logClass = type === 'success' ? 'log-success' : 
                       type === 'error' ? 'log-error' : 'log-info';
      
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> <span class="${logClass}">${message}</span>`;
      
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    /**
     * 取得資料數量統計
     */
    function getDataCounts() {
      // This would be implemented in the backend
      return {
        teachers: 0,
        classes: 0,
        students: 0
      };
    }
    
    /**
     * 取得系統狀態
     */
    function getSystemStatus() {
      return {
        apiUrl: 'https://api.cloudschool.tw',
        lastSync: '從未同步'
      };
    }
  </script>
</body>
</html>

