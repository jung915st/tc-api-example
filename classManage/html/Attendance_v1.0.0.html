<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é»å - <?= teacherInfo.className ?></title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <?!= include('Common_v1.0.0'); ?>
</head>
<body>
  <!-- å°èˆªåˆ— -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="?page=dashboard" class="navbar-brand">
        <i class="fas fa-school"></i>
        <span><?= teacherInfo.className ?> ç­ç´šç®¡ç†</span>
      </a>
      
      <button class="navbar-toggle" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul class="navbar-menu">
        <li><a href="?page=dashboard"><i class="fas fa-home"></i> å„€è¡¨æ¿</a></li>
        <li><a href="?page=attendance" class="active"><i class="fas fa-check-square"></i> é»å</a></li>
        <li><a href="?page=homework"><i class="fas fa-book"></i> ä½œæ¥­</a></li>
        <li><a href="?page=leave"><i class="fas fa-file-alt"></i> è«‹å‡</a></li>
        <li><a href="?page=students"><i class="fas fa-users"></i> å­¸ç”Ÿ</a></li>
      </ul>
      
      <div class="navbar-user">
        <i class="fas fa-user-circle"></i>
        <span><?= teacherInfo.name ?></span>
      </div>
    </div>
  </nav>
  
  <!-- ä¸»è¦å…§å®¹ -->
  <div class="container">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="card">
      <div class="card-header">
        <div>
          <h1 class="card-title">
            <i class="fas fa-check-square"></i>
            ä»Šæ—¥é»å
          </h1>
          <p class="text-muted" style="margin-top: 6px;" id="selectedClassLabel">
            ç­ç´šï¼šå°šæœªé¸æ“‡
          </p>
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
          <span class="text-muted">
            <i class="fas fa-calendar"></i>
            <span id="todayDate"></span>
          </span>
          <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">
            <button class="btn btn-secondary btn-sm" onclick="loadAttendanceData(true)" id="reloadRosterBtn">
              <i class="fas fa-rotate-right"></i> æ›´æ–°åå–®
            </button>
            <button class="btn btn-primary" onclick="submitAttendance()" id="submitBtn">
              <i class="fas fa-save"></i> å„²å­˜é»åè¨˜éŒ„
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ç­ç´šé¸æ“‡ -->
    <div class="card">
      <div class="card-body">
        <div class="form-row" style="align-items: flex-end;">
          <div class="form-group">
            <label class="form-label">å¹´ç´š</label>
            <select id="gradeSelect" class="form-control" onchange="onGradeChange()">
              <option value="">è«‹é¸æ“‡å¹´ç´š</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ç­ç´š</label>
            <select id="classSelect" class="form-control" onchange="onClassChange()">
              <option value="">è«‹é¸æ“‡ç­ç´š</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">å°å¸«</label>
            <div id="homeroomTeacher" class="text-muted">â€”</div>
          </div>
          <div class="form-group">
            <label class="form-label">å­¸ç”Ÿæ•¸</label>
            <div id="classStudentCount" class="text-muted">-</div>
          </div>
          <div class="form-group" style="align-self: flex-end;">
            <button class="btn btn-outline btn-sm" onclick="refreshSemesterDirectory()">
              <i class="fas fa-sync-alt"></i> é‡æ–°è¼‰å…¥ç­ç´š
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="card">
      <div class="card-body">
        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
          <span style="font-weight: 600;">å¿«é€Ÿè¨­å®šï¼š</span>
          <button class="btn btn-success btn-sm" onclick="setAllStatus('å‡ºå¸­')">
            <i class="fas fa-check-double"></i> å…¨éƒ¨å‡ºå¸­
          </button>
          <button class="btn btn-secondary btn-sm" onclick="clearAllStatus()">
            <i class="fas fa-eraser"></i> æ¸…é™¤å…¨éƒ¨
          </button>
          <span class="text-muted" style="margin-left: auto;">
            å·²è¨˜éŒ„ï¼š<span id="recordCount">0</span> ä½
          </span>
          <span class="text-muted" id="rosterMeta"></span>
        </div>
      </div>
    </div>
    
    <!-- é»åè¡¨æ ¼ -->
    <div class="card">
      <div class="card-body">
        <div id="attendanceTable">
          <div class="loading">
            <div class="spinner"></div>
            <p>è¼‰å…¥å­¸ç”Ÿåå–®ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    const teacherDefaultClassName = '<?= teacherInfo.className ?>';
    let studentsData = [];
    let semesterDirectory = null;
    let currentClassInfo = null;
    let currentRosterMetadata = null;
    
    window.onload = function() {
      updateTodayDate();
      loadSemesterDirectory();
    };
    
    function updateTodayDate() {
      const today = new Date();
      const dateString = today.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });
      document.getElementById('todayDate').textContent = dateString;
    }
    
    function loadSemesterDirectory(forceRefresh) {
      currentClassInfo = null;
      currentRosterMetadata = null;
      studentsData = [];
      showLoading('attendanceTable');
      
      google.script.run
        .withSuccessHandler(onDirectoryLoaded)
        .withFailureHandler(onDataError)
        .getSemesterDirectory({ forceRefresh: Boolean(forceRefresh) });
    }
    
    function refreshSemesterDirectory() {
      loadSemesterDirectory(true);
    }
    
    function onDirectoryLoaded(data) {
      if (data.error) {
        showError('attendanceTable', data.error);
        return;
      }
      
      semesterDirectory = data;
      populateGradeOptions();
      selectDefaultClass();
    }
    
    function populateGradeOptions() {
      const gradeSelect = document.getElementById('gradeSelect');
      if (!gradeSelect || !semesterDirectory) return;
      
      const classes = semesterDirectory.classes || [];
      const grades = Array.from(new Set(classes.map(cls => cls.grade))).sort((a, b) => a - b);
      gradeSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¹´ç´š</option>' + 
        grades.map(grade => `<option value="${grade}">${grade} å¹´ç´š</option>`).join('');
    }
    
    function selectDefaultClass() {
      const classes = semesterDirectory?.classes || [];
      if (classes.length === 0) {
        showError('attendanceTable', 'ç›®å‰æ²’æœ‰ç­ç´šè³‡æ–™ï¼Œè«‹ç¢ºèª tc-api æ˜¯å¦å·²åŒæ­¥ã€‚');
        return;
      }
      
      let defaultClass = classes.find(cls => teacherDefaultClassName && cls.displayName.includes(teacherDefaultClassName));
      if (!defaultClass) {
        defaultClass = classes[0];
      }
      
      const gradeSelect = document.getElementById('gradeSelect');
      gradeSelect.value = defaultClass.grade;
      updateClassSelect();
      
      const classSelect = document.getElementById('classSelect');
      classSelect.value = defaultClass.classSeq;
      onClassChange();
    }
    
    function updateClassSelect() {
      const classSelect = document.getElementById('classSelect');
      const gradeValue = Number(document.getElementById('gradeSelect').value);
      const classes = semesterDirectory?.classes || [];
      const filtered = classes.filter(cls => cls.grade === gradeValue);
      
      classSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç­ç´š</option>' + 
        filtered.map(cls => `<option value="${cls.classSeq}">${cls.className} (${cls.classSeq})</option>`).join('');
    }
    
    function onGradeChange() {
      updateClassSelect();
      currentClassInfo = null;
      studentsData = [];
      currentRosterMetadata = null;
      updateClassInfoPanel();
      renderAttendanceTable();
    }
    
    function onClassChange() {
      const gradeValue = Number(document.getElementById('gradeSelect').value);
      const classSeqValue = Number(document.getElementById('classSelect').value);
      
      if (!gradeValue || !classSeqValue) {
        currentClassInfo = null;
        updateClassInfoPanel();
        showError('attendanceTable', 'è«‹å…ˆé¸æ“‡ç­ç´š');
        return;
      }
      
      const selected = (semesterDirectory?.classes || []).find(cls => 
        cls.grade === gradeValue && cls.classSeq === classSeqValue
      );
      
      if (!selected) {
        showError('attendanceTable', 'æ‰¾ä¸åˆ°é¸å–çš„ç­ç´š');
        return;
      }
      
      currentClassInfo = { ...selected };
      updateClassInfoPanel();
      loadAttendanceData();
    }
    
    function updateClassInfoPanel() {
      const label = document.getElementById('selectedClassLabel');
      const teacherEl = document.getElementById('homeroomTeacher');
      const countEl = document.getElementById('classStudentCount');
      const rosterMeta = document.getElementById('rosterMeta');
      
      if (currentClassInfo) {
        const studentCount = currentClassInfo.studentCount || studentsData.length || 0;
        label.textContent = `ç­ç´šï¼š${currentClassInfo.displayName || 'â€”'}`;
        teacherEl.textContent = currentClassInfo.teacherName || 'â€”';
        countEl.textContent = studentCount ? `${studentCount} ä½` : '-';
      } else {
        label.textContent = 'ç­ç´šï¼šå°šæœªé¸æ“‡';
        teacherEl.textContent = 'â€”';
        countEl.textContent = '-';
      }
      
      if (currentRosterMetadata) {
        const year = currentRosterMetadata.schoolYear || '-';
        const semester = currentRosterMetadata.semester || '-';
        rosterMeta.textContent = `ä¾†æºï¼š${year} å­¸å¹´ ç¬¬ ${semester} å­¸æœŸ`;
      } else {
        rosterMeta.textContent = '';
      }
    }
    
    function loadAttendanceData(forceRefreshRoster) {
      if (!currentClassInfo) {
        showError('attendanceTable', 'è«‹å…ˆé¸æ“‡ç­ç´š');
        return;
      }
      
      showLoading('attendanceTable');
      google.script.run
        .withSuccessHandler(onRosterLoaded)
        .withFailureHandler(onDataError)
        .getTodayAttendanceData({
          grade: currentClassInfo.grade,
          classSeq: currentClassInfo.classSeq,
          className: currentClassInfo.className,
          forceRefresh: Boolean(forceRefreshRoster)
        });
    }
    
    function onRosterLoaded(data) {
      if (data.error) {
        showError('attendanceTable', data.error);
        return;
      }
      
      studentsData = data.students || [];
      currentRosterMetadata = data.metadata || null;
      if (data.classInfo) {
        currentClassInfo = { ...currentClassInfo, ...data.classInfo };
      }
      updateClassInfoPanel();
      renderAttendanceTable();
      updateRecordCount();
    }
    
    function onDataError(error) {
      showError('attendanceTable', 'è¼‰å…¥å¤±æ•—ï¼š' + error);
      document.getElementById('recordCount').textContent = '0';
    }
    
    function renderAttendanceTable() {
      const container = document.getElementById('attendanceTable');
      
      if (!studentsData || studentsData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-users-slash"></i>
            <p>è«‹å…ˆé¸æ“‡ç­ç´šä»¥è¼‰å…¥å­¸ç”Ÿåå–®</p>
          </div>
        `;
        return;
      }
      
      let html = '<div class="table-container"><table>';
      html += `
        <thead>
          <tr>
            <th style="width: 80px;">åº§è™Ÿ</th>
            <th>å§“å</th>
            <th style="width: 200px;">å‡ºå¸­ç‹€æ…‹</th>
            <th>å‚™è¨»</th>
            <th style="width: 100px;">ç‹€æ…‹</th>
          </tr>
        </thead>
        <tbody>
      `;
      
      studentsData.forEach((student, index) => {
        const hasRecord = student.hasRecord;
        const statusBadge = hasRecord ? 
          '<span class="badge badge-success"><i class="fas fa-check"></i> å·²è¨˜éŒ„</span>' : 
          '<span class="badge badge-warning"><i class="fas fa-clock"></i> æœªè¨˜éŒ„</span>';
        
        html += `
          <tr>
            <td style="text-align: center; font-weight: 600;">${student.seatNumber}</td>
            <td style="font-weight: 500;">
              ${student.name}
              ${student.studentNo ? `<div class="text-muted" style="font-size: 12px;">å­¸è™Ÿï¼š${student.studentNo}</div>` : ''}
            </td>
            <td>
              <select class="form-control" id="status-${index}" onchange="updateRecordCount()">
                <option value="">-- è«‹é¸æ“‡ --</option>
                <option value="å‡ºå¸­" ${student.status === 'å‡ºå¸­' ? 'selected' : ''}>âœ“ å‡ºå¸­</option>
                <option value="ç—…å‡" ${student.status === 'ç—…å‡' ? 'selected' : ''}>ğŸ¥ ç—…å‡</option>
                <option value="äº‹å‡" ${student.status === 'äº‹å‡' ? 'selected' : ''}>ğŸ“‹ äº‹å‡</option>
                <option value="æ› èª²" ${student.status === 'æ› èª²' ? 'selected' : ''}>âŒ æ› èª²</option>
                <option value="é²åˆ°" ${student.status === 'é²åˆ°' ? 'selected' : ''}>â° é²åˆ°</option>
              </select>
            </td>
            <td>
              <input type="text" 
                     class="form-control" 
                     id="notes-${index}" 
                     value="${student.notes || ''}"
                     placeholder="é¸å¡«">
            </td>
            <td style="text-align: center;">
              ${statusBadge}
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }
    
    function setAllStatus(status) {
      if (!studentsData.length) return;
      
      studentsData.forEach((student, index) => {
        const select = document.getElementById(`status-${index}`);
        if (select) {
          select.value = status;
        }
      });
      updateRecordCount();
    }
    
    function clearAllStatus() {
      if (!studentsData.length) {
        alert('è«‹å…ˆè¼‰å…¥å­¸ç”Ÿåå–®ã€‚');
        return;
      }
      
      if (!confirmAction('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰é»åè¨˜éŒ„å—ï¼Ÿ')) {
        return;
      }
      
      studentsData.forEach((student, index) => {
        const select = document.getElementById(`status-${index}`);
        const notes = document.getElementById(`notes-${index}`);
        if (select) select.value = '';
        if (notes) notes.value = '';
      });
      updateRecordCount();
    }
    
    function updateRecordCount() {
      if (!studentsData.length) {
        document.getElementById('recordCount').textContent = '0';
        return;
      }
      
      let count = 0;
      studentsData.forEach((student, index) => {
        const select = document.getElementById(`status-${index}`);
        if (select && select.value !== '') {
          count++;
        }
      });
      document.getElementById('recordCount').textContent = count;
    }
    
    function submitAttendance() {
      if (!studentsData.length) {
        alert('è«‹å…ˆè¼‰å…¥å­¸ç”Ÿåå–®ã€‚');
        return;
      }
      
      if (!currentClassInfo) {
        alert('è«‹å…ˆé¸æ“‡ç­ç´šã€‚');
        return;
      }
      
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.textContent;
      
      const records = [];
      studentsData.forEach((student, index) => {
        const statusSelect = document.getElementById(`status-${index}`);
        const notesInput = document.getElementById(`notes-${index}`);
        
        const status = statusSelect ? statusSelect.value : '';
        const notes = notesInput ? notesInput.value : '';
        
        if (status !== '') {
          records.push({
            seatNumber: student.seatNumber,
            name: student.name,
            status: status,
            notes: notes
          });
        }
      });
      
      if (records.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€ä½å­¸ç”Ÿçš„å‡ºå¸­ç‹€æ…‹ï¼');
        return;
      }
      
      if (!confirmAction(`ç¢ºå®šè¦å„²å­˜ ${records.length} ä½å­¸ç”Ÿçš„é»åè¨˜éŒ„å—ï¼Ÿ`)) {
        return;
      }
      
      disableButton(submitBtn);
      
      google.script.run
        .withSuccessHandler(function(result) {
          enableButton(submitBtn, originalText);
          
          if (result.success) {
            showSuccess(result.message);
            setTimeout(function() {
              loadAttendanceData(true);
            }, 800);
          } else {
            alert('å„²å­˜å¤±æ•—ï¼š' + result.error);
          }
        })
        .withFailureHandler(function(error) {
          enableButton(submitBtn, originalText);
          alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error);
        })
        .handleAddAttendance({
          classInfo: currentClassInfo,
          records: records
        });
    }
  </script>
</body>
</html>
