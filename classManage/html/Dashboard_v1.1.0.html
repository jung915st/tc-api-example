<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><?= teacherInfo.className ?> - ç­ç´šç®¡ç†ç³»çµ±</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Chart.js for real-time charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <?!= include('Common_v1.0.0'); ?>
  
  <style>
    .attendance-chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .class-attendance-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.3s ease;
    }
    
    .class-attendance-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    
    .class-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .class-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .class-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 13px;
    }
    
    .stat-label {
      color: #666;
    }
    
    .stat-value {
      font-weight: 600;
      color: #333;
    }
    
    .stat-value.present { color: #4caf50; }
    .stat-value.absent { color: #f44336; }
    .stat-value.sick { color: #ff9800; }
    .stat-value.late { color: #9c27b0; }
    
    @media (max-width: 768px) {
      .chart-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- å°èˆªåˆ— -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="?page=dashboard" class="navbar-brand">
        <i class="fas fa-school"></i>
        <span><?= teacherInfo.className ?> ç­ç´šç®¡ç†</span>
      </a>
      
      <button class="navbar-toggle" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul class="navbar-menu">
        <li><a href="?page=dashboard" class="active"><i class="fas fa-home"></i> å„€è¡¨æ¿</a></li>
        <li><a href="?page=attendance"><i class="fas fa-check-square"></i> é»å</a></li>
        <li><a href="?page=homework"><i class="fas fa-book"></i> ä½œæ¥­</a></li>
        <li><a href="?page=leave"><i class="fas fa-file-alt"></i> è«‹å‡</a></li>
        <li><a href="?page=students"><i class="fas fa-users"></i> å­¸ç”Ÿ</a></li>
        <li><a href="?page=sync"><i class="fas fa-sync"></i> åŒæ­¥</a></li>
      </ul>
      
      <div class="navbar-user">
        <i class="fas fa-user-circle"></i>
        <span id="userDisplayName"><?= userName || teacherInfo.name ?></span>
        <? if (isLoggedIn) { ?>
        <button class="btn btn-sm" onclick="handleLogout()" style="margin-left: 10px; padding: 5px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
          <i class="fas fa-sign-out-alt"></i> ç™»å‡º
        </button>
        <? } ?>
      </div>
    </div>
  </nav>
  
  <!-- ä¸»è¦å…§å®¹ -->
  <div class="container">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="card">
      <div class="card-header">
        <div>
          <h1 class="card-title">
            <i class="fas fa-chart-line"></i>
            ç­ç´šç¸½è¦½
          </h1>
          <p class="text-muted" style="margin-top: 5px; font-size: 14px;">
            æ­¡è¿ï¼Œ<?= teacherInfo.name ?> è€å¸« | 
            <span id="lastUpdate">è¼‰å…¥ä¸­...</span>
          </p>
        </div>
        <button class="btn btn-primary btn-sm" onclick="refreshDashboard()">
          <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
        </button>
      </div>
    </div>
    
    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card blue">
        <div class="stat-icon"><i class="fas fa-users"></i></div>
        <div class="stat-number" id="totalStudents">-</div>
        <div class="stat-label">å­¸ç”Ÿç¸½æ•¸</div>
      </div>
      
      <div class="stat-card red">
        <div class="stat-icon"><i class="fas fa-user-times"></i></div>
        <div class="stat-number" id="todayAbsence">-</div>
        <div class="stat-label">ä»Šæ—¥ç¼ºæ› </div>
      </div>
      
      <div class="stat-card orange">
        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="stat-number" id="overdueHomework">-</div>
        <div class="stat-label">é€¾æœŸæœªäº¤ä½œæ¥­</div>
      </div>
      
      <div class="stat-card green">
        <div class="stat-icon"><i class="fas fa-clipboard-check"></i></div>
        <div class="stat-number" id="pendingLeaves">-</div>
        <div class="stat-label">å¾…å¯©æ ¸è«‹å‡</div>
      </div>
    </div>
    
    <!-- å³æ™‚å‡ºå¸­çµ±è¨ˆåœ–è¡¨ - NEW -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-chart-pie"></i>
          ä»Šæ—¥å„ç­å‡ºå¸­çµ±è¨ˆï¼ˆå³æ™‚æ›´æ–°ï¼‰
        </h2>
        <button class="btn btn-secondary btn-sm" onclick="refreshAttendanceCharts()">
          <i class="fas fa-sync-alt"></i> æ›´æ–°åœ–è¡¨
        </button>
      </div>
      <div class="card-body">
        <div id="attendanceChartSection">
          <div class="loading">
            <div class="spinner"></div>
            <p>è¼‰å…¥å‡ºå¸­çµ±è¨ˆä¸­...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- è©³ç´°è³‡è¨Š -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
      <!-- æ˜¨æ—¥ç¼ºæ› è¨˜éŒ„ -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-calendar-day"></i>
            æ˜¨æ—¥ç¼ºæ› è¨˜éŒ„
          </h2>
        </div>
        <div class="card-body">
          <div id="absenceList" style="max-height: 400px; overflow-y: auto;">
            <div class="loading">
              <div class="spinner"></div>
              <p>è¼‰å…¥ä¸­...</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- é€¾æœŸæœªäº¤ä½œæ¥­ -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-exclamation-triangle"></i>
            é€¾æœŸæœªäº¤ä½œæ¥­
          </h2>
        </div>
        <div class="card-body">
          <div id="homeworkList" style="max-height: 400px; overflow-y: auto;">
            <div class="loading">
              <div class="spinner"></div>
              <p>è¼‰å…¥ä¸­...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å¾…å¯©æ ¸è«‹å‡å–® -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-file-alt"></i>
          å¾…å¯©æ ¸è«‹å‡å–®
        </h2>
      </div>
      <div class="card-body">
        <div id="leaveList">
          <div class="loading">
            <div class="spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- é å°¾ -->
    <div style="text-align: center; margin-top: 30px; padding: 20px; color: var(--text-muted); font-size: 13px;">
      <p>ç­ç´šç®¡ç†ç³»çµ± v<?= version ?> | 
        UTC+8 æ™‚å€ | 
        <span id="currentTime"></span>
      </p>
    </div>
  </div>
  
  <script>
    // å…¨åŸŸè®Šæ•¸
    let dashboardData = null;
    let attendanceCharts = {};
    
    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    window.onload = function() {
      loadDashboardData();
      updateCurrentTime();
      setInterval(updateCurrentTime, 1000);
      
      // Auto refresh every 5 minutes
      setInterval(refreshDashboard, 300000);
    };
    
    /**
     * è¼‰å…¥å„€è¡¨æ¿è³‡æ–™
     */
    function loadDashboardData() {
      showLoading('absenceList');
      showLoading('homeworkList');
      showLoading('leaveList');
      showLoading('attendanceChartSection');
      
      google.script.run
        .withSuccessHandler(onDataLoaded)
        .withFailureHandler(onDataError)
        .getDashboardData();
    }
    
    /**
     * è³‡æ–™è¼‰å…¥æˆåŠŸ
     */
    function onDataLoaded(data) {
      if (data.error) {
        showError('absenceList', data.error);
        showError('homeworkList', data.error);
        showError('leaveList', data.error);
        showError('attendanceChartSection', data.error);
        return;
      }
      
      dashboardData = data;
      
      // æ›´æ–°çµ±è¨ˆæ•¸å­—
      document.getElementById('totalStudents').textContent = data.summary.totalStudents;
      document.getElementById('todayAbsence').textContent = data.summary.todayAbsence;
      document.getElementById('overdueHomework').textContent = data.summary.overdueHomework;
      document.getElementById('pendingLeaves').textContent = data.summary.pendingLeaves;
      document.getElementById('lastUpdate').textContent = 'æ›´æ–°æ™‚é–“ï¼š' + data.lastUpdate;
      
      // æ›´æ–°å„å€‹æ¸…å–®
      renderAbsenceList(data.absenceList);
      renderHomeworkList(data.homeworkList);
      renderLeaveList(data.leaveList);
      
      // Render attendance charts - NEW
      renderAttendanceCharts(data.attendanceStats);
    }
    
    /**
     * æ¸²æŸ“å³æ™‚å‡ºå¸­çµ±è¨ˆåœ–è¡¨ - NEW
     */
    function renderAttendanceCharts(attendanceStats) {
      const container = document.getElementById('attendanceChartSection');
      
      if (!attendanceStats || attendanceStats.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-chart-pie"></i>
            <p>ä»Šæ—¥å°šç„¡å‡ºå¸­è¨˜éŒ„</p>
            <a href="?page=attendance" class="btn btn-primary btn-sm">
              <i class="fas fa-check-square"></i> å‰å¾€é»å
            </a>
          </div>
        `;
        return;
      }
      
      let html = '<div class="chart-grid">';
      
      attendanceStats.forEach((classData, index) => {
        const chartId = `chart-${classData.grade}-${classData.classSeq}`;
        const total = classData.present + classData.absent + classData.sick + classData.personal + classData.late;
        const attendanceRate = total > 0 ? Math.round((classData.present / total) * 100) : 0;
        
        html += `
          <div class="class-attendance-card">
            <div class="class-header">
              <div class="class-title">
                <i class="fas fa-users"></i> ${classData.className}
              </div>
              <div>
                <span class="badge ${attendanceRate >= 90 ? 'badge-success' : attendanceRate >= 70 ? 'badge-warning' : 'badge-danger'}">
                  å‡ºå¸­ç‡ ${attendanceRate}%
                </span>
              </div>
            </div>
            
            <canvas id="${chartId}" height="200"></canvas>
            
            <div class="class-stats">
              <div class="stat-item">
                <span class="stat-label">âœ“ å‡ºå¸­</span>
                <span class="stat-value present">${classData.present}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">âŒ æ› èª²</span>
                <span class="stat-value absent">${classData.absent}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ğŸ¥ ç—…å‡</span>
                <span class="stat-value sick">${classData.sick}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ğŸ“‹ äº‹å‡</span>
                <span class="stat-value">${classData.personal}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">â° é²åˆ°</span>
                <span class="stat-value late">${classData.late}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ç¸½è¨ˆ</span>
                <span class="stat-value">${total}</span>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
      
      // Render charts
      attendanceStats.forEach((classData) => {
        const chartId = `chart-${classData.grade}-${classData.classSeq}`;
        renderChart(chartId, classData);
      });
    }
    
    /**
     * æ¸²æŸ“å–®ä¸€ç­ç´šåœ–è¡¨ - NEW
     */
    function renderChart(chartId, classData) {
      const ctx = document.getElementById(chartId);
      
      if (!ctx) return;
      
      // Destroy existing chart if exists
      if (attendanceCharts[chartId]) {
        attendanceCharts[chartId].destroy();
      }
      
      attendanceCharts[chartId] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['å‡ºå¸­', 'æ› èª²', 'ç—…å‡', 'äº‹å‡', 'é²åˆ°'],
          datasets: [{
            data: [
              classData.present,
              classData.absent,
              classData.sick,
              classData.personal,
              classData.late
            ],
            backgroundColor: [
              '#4caf50',  // green for present
              '#f44336',  // red for absent
              '#ff9800',  // orange for sick
              '#2196f3',  // blue for personal
              '#9c27b0'   // purple for late
            ],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${label}: ${value} äºº (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    /**
     * æ›´æ–°å‡ºå¸­åœ–è¡¨ - NEW
     */
    function refreshAttendanceCharts() {
      showLoading('attendanceChartSection');
      
      google.script.run
        .withSuccessHandler(function(data) {
          if (data.error) {
            showError('attendanceChartSection', data.error);
            return;
          }
          renderAttendanceCharts(data.attendanceStats);
          showSuccess('åœ–è¡¨å·²æ›´æ–°');
        })
        .withFailureHandler(function(error) {
          showError('attendanceChartSection', error);
        })
        .getDashboardData();
    }
    
    /**
     * è³‡æ–™è¼‰å…¥å¤±æ•—
     */
    function onDataError(error) {
      console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
      showError('absenceList', 'è¼‰å…¥å¤±æ•—ï¼š' + error);
      showError('homeworkList', 'è¼‰å…¥å¤±æ•—ï¼š' + error);
      showError('leaveList', 'è¼‰å…¥å¤±æ•—ï¼š' + error);
      showError('attendanceChartSection', 'è¼‰å…¥å¤±æ•—ï¼š' + error);
    }
    
    /**
     * æ¸²æŸ“ç¼ºæ› è¨˜éŒ„æ¸…å–®
     */
    function renderAbsenceList(list) {
      const container = document.getElementById('absenceList');
      
      if (!list || list.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <p>å…¨ç­å‡ºå¸­ï¼Œç„¡ç¼ºæ› è¨˜éŒ„</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      list.forEach(item => {
        const badgeClass = item.status === 'æ› èª²' ? 'badge-danger' : 
                          item.status === 'ç—…å‡' ? 'badge-warning' : 'badge-info';
        
        html += `
          <div style="padding: 12px; border-left: 4px solid var(--primary-color); background: #f8f9ff; margin-bottom: 10px; border-radius: 6px;">
            <div style="font-weight: 600; margin-bottom: 4px;">
              ${item.name} <span class="badge ${badgeClass}">${item.status}</span>
            </div>
            <div style="font-size: 13px; color: var(--text-light);">
              åº§è™Ÿï¼š${item.seatNumber}
              ${item.notes ? ' | å‚™è¨»ï¼š' + item.notes : ''}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    /**
     * æ¸²æŸ“ä½œæ¥­æ¸…å–®
     */
    function renderHomeworkList(list) {
      const container = document.getElementById('homeworkList');
      
      if (!list || list.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <p>ç„¡é€¾æœŸæœªäº¤ä½œæ¥­</p>
          </div>
        `;
        return;
      }
      
      // ä¾å­¸ç”Ÿåˆ†çµ„
      const grouped = {};
      list.forEach(item => {
        const key = `${item.seatNumber}-${item.studentName}`;
        if (!grouped[key]) {
          grouped[key] = {
            seatNumber: item.seatNumber,
            studentName: item.studentName,
            homeworks: []
          };
        }
        grouped[key].homeworks.push(`${item.subject} - ${item.homeworkName}`);
      });
      
      let html = '';
      Object.values(grouped).forEach(student => {
        html += `
          <div style="padding: 12px; border-left: 4px solid var(--warning-color); background: #fff8e1; margin-bottom: 10px; border-radius: 6px;">
            <div style="font-weight: 600; margin-bottom: 4px;">
              ${student.studentName} 
              <span class="badge badge-danger">${student.homeworks.length} é …</span>
            </div>
            <div style="font-size: 13px; color: var(--text-light);">
              åº§è™Ÿï¼š${student.seatNumber}<br>
              æœªäº¤ä½œæ¥­ï¼š${student.homeworks.join('ã€')}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    /**
     * æ¸²æŸ“è«‹å‡æ¸…å–®
     */
    function renderLeaveList(list) {
      const container = document.getElementById('leaveList');
      
      if (!list || list.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <p>ç„¡å¾…å¯©æ ¸è«‹å‡å–®</p>
          </div>
        `;
        return;
      }
      
      let html = '<div class="table-container"><table>';
      html += `
        <thead>
          <tr>
            <th>å­¸ç”Ÿ</th>
            <th>åº§è™Ÿ</th>
            <th>è«‹å‡æ—¥æœŸ</th>
            <th>é¡å‹</th>
            <th>åŸå› </th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
      `;
      
      list.forEach(item => {
        html += `
          <tr>
            <td>${item.studentName}</td>
            <td>${item.seatNumber || '-'}</td>
            <td>${item.leaveDate}</td>
            <td><span class="badge badge-info">${item.leaveType}</span></td>
            <td>${item.reason}</td>
            <td>
              <button class="btn btn-success btn-sm" onclick="approveLeave(${item.rowIndex}, 'å·²æ ¸å‡†')">
                <i class="fas fa-check"></i> æ ¸å‡†
              </button>
              <button class="btn btn-danger btn-sm" onclick="approveLeave(${item.rowIndex}, 'å·²æ‹’çµ•')">
                <i class="fas fa-times"></i> æ‹’çµ•
              </button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }
    
    /**
     * å¯©æ ¸è«‹å‡
     */
    function approveLeave(rowIndex, approvalStatus) {
      const action = approvalStatus === 'å·²æ ¸å‡†' ? 'æ ¸å‡†' : 'æ‹’çµ•';
      
      if (!confirmAction(`ç¢ºå®šè¦${action}é€™ç­†è«‹å‡ç”³è«‹å—ï¼Ÿ`)) {
        return;
      }
      
      showLoading('leaveList');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess(result.message);
            loadDashboardData();
          } else {
            showError('leaveList', result.error);
          }
        })
        .withFailureHandler(function(error) {
          showError('leaveList', error);
        })
        .handleApproveLeave({
          rowIndex: rowIndex,
          approvalStatus: approvalStatus,
          notes: ''
        });
    }
    
    /**
     * é‡æ–°æ•´ç†å„€è¡¨æ¿
     */
    function refreshDashboard() {
      loadDashboardData();
      showSuccess('è³‡æ–™å·²æ›´æ–°');
    }
    
    /**
     * æ›´æ–°ç•¶å‰æ™‚é–“
     */
    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleString('zh-TW', { 
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      const element = document.getElementById('currentTime');
      if (element) {
        element.textContent = timeString;
      }
    }
    
    /**
     * è™•ç†ç™»å‡º
     */
    function handleLogout() {
      if (!confirmAction('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('ç™»å‡ºæˆåŠŸï¼æ­£åœ¨è·³è½‰...');
            setTimeout(function() {
              window.location.href = '?page=login';
            }, 1000);
          } else {
            alert('ç™»å‡ºå¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
          }
        })
        .withFailureHandler(function(error) {
          alert('ç™»å‡ºç™¼ç”ŸéŒ¯èª¤ï¼š' + error);
        })
        .logoutTeacher();
    }
  </script>
  
  <!-- éŸ¿æ‡‰å¼èª¿æ•´ -->
  <style>
    @media (max-width: 1024px) {
      div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
</body>
</html>

