## æ–¹æ³• 2ï¼šç¨ç«‹å¼è…³æœ¬ï¼ˆStandalone Scriptï¼‰

### ğŸ“‹ ä½¿ç”¨å ´æ™¯
- éœ€è¦æ“ä½œ**å¤šå€‹ä¸åŒçš„è©¦ç®—è¡¨**
- é–‹ç™¼ Web App æ‡‰ç”¨ç¨‹å¼
- å»ºç«‹å¯é‡è¤‡ä½¿ç”¨çš„å‡½å¼åº«
- é›†ä¸­ç®¡ç†å¤šå€‹è‡ªå‹•åŒ–ä»»å‹™

### ğŸ¯ å»ºç«‹æ­¥é©Ÿ

#### æ­¥é©Ÿ 1ï¼šå»ºç«‹ç¨ç«‹è…³æœ¬
1. å‰å¾€ https://script.google.com
2. é»æ“Šã€Œ+ æ–°å¢å°ˆæ¡ˆã€
3. å°‡å°ˆæ¡ˆå‘½åç‚ºã€Œå¤©æ°£è³‡æ–™æŠ“å–å·¥å…·ï¼ˆç¨ç«‹ç‰ˆï¼‰ã€
4. è²¼ä¸Šä¸‹æ–¹çš„å®Œæ•´ç¨‹å¼ç¢¼

#### æ­¥é©Ÿ 2ï¼šå®Œæ•´ç¨‹å¼ç¢¼

```javascript
/**
 * ==========================================
 * ç¨ç«‹å¼è…³æœ¬ç‰ˆæœ¬ - å¤©æ°£è³‡æ–™æŠ“å–å·¥å…·
 * ==========================================
 * æ­¤è…³æœ¬ç¨ç«‹å­˜åœ¨ï¼Œéœ€æ˜ç¢ºæŒ‡å®šè¦æ“ä½œçš„è©¦ç®—è¡¨
 */

/**
 * é…ç½®å€ï¼šè¨­å®šç›®æ¨™è©¦ç®—è¡¨
 * 
 * å–å¾—è©¦ç®—è¡¨ ID çš„æ–¹æ³•ï¼š
 * é–‹å•Ÿè©¦ç®—è¡¨ï¼Œç¶²å€æ ¼å¼ç‚ºï¼š
 * https://docs.google.com/spreadsheets/d/[è©¦ç®—è¡¨ID]/edit
 * 
 * è¤‡è£½ [è©¦ç®—è¡¨ID] é€™æ®µæ–‡å­—ä¸¦è²¼åˆ°ä¸‹æ–¹
 */
const CONFIG = {
  // æ–¹æ³• 1ï¼šä½¿ç”¨è©¦ç®—è¡¨ IDï¼ˆæ¨è–¦ï¼‰
  SPREADSHEET_ID: 'YOUR_SPREADSHEET_ID_HERE',
  
  // æ–¹æ³• 2ï¼šä½¿ç”¨è©¦ç®—è¡¨ç¶²å€ï¼ˆä¹Ÿå¯ä»¥ï¼‰
  // SPREADSHEET_URL: 'https://docs.google.com/spreadsheets/d/YOUR_SPREADSHEET_ID/edit',
  
  // å·¥ä½œè¡¨åç¨±
  SHEET_NAME: 'å¤©æ°£é å ±'
};

/**
 * å®‰å…¨çš„æ—¥æœŸæ ¼å¼åŒ–å‡½å¼
 */
function formatDate(date) {
  try {
    if (!date || isNaN(date.getTime())) {
      return 'æ—¥æœŸç„¡æ•ˆ';
    }
    const timezone = Session.getScriptTimeZone();
    return Utilities.formatDate(date, timezone, 'yyyy/MM/dd HH:mm:ss');
  } catch (e) {
    return 'ç„¡æ³•æ ¼å¼åŒ–æ—¥æœŸ';
  }
}

/**
 * è¨­å®š API Keyï¼ˆç¨ç«‹å¼ç‰ˆæœ¬ï¼‰
 */
function setupCWAApiKey() {
  const apiKey = 'CWA-YOUR-ACTUAL-API-KEY'; // æ›¿æ›æˆæ‚¨çš„ API Key
  PropertiesService.getScriptProperties().setProperty('CWA_API_KEY', apiKey);
  Logger.log('âœ… API Key å·²å®‰å…¨å„²å­˜');
}

/**
 * å–å¾— API Key
 */
function getCWAApiKey() {
  return PropertiesService.getScriptProperties().getProperty('CWA_API_KEY');
}

/**
 * å–å¾—ç›®æ¨™è©¦ç®—è¡¨ï¼ˆç¨ç«‹å¼è…³æœ¬å¿…é ˆæ˜ç¢ºæŒ‡å®šï¼‰
 */
function getTargetSpreadsheet() {
  try {
    // æ–¹æ³• 1ï¼šä½¿ç”¨è©¦ç®—è¡¨ ID
    if (CONFIG.SPREADSHEET_ID && CONFIG.SPREADSHEET_ID !== 'YOUR_SPREADSHEET_ID_HERE') {
      return SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    }
    
    // æ–¹æ³• 2ï¼šä½¿ç”¨è©¦ç®—è¡¨ URL
    if (CONFIG.SPREADSHEET_URL) {
      return SpreadsheetApp.openByUrl(CONFIG.SPREADSHEET_URL);
    }
    
    // æ–¹æ³• 3ï¼šå»ºç«‹æ–°è©¦ç®—è¡¨
    Logger.log('âš ï¸ æœªè¨­å®šè©¦ç®—è¡¨ IDï¼Œå°‡å»ºç«‹æ–°è©¦ç®—è¡¨');
    const newSs = SpreadsheetApp.create('å¤©æ°£é å ±_' + new Date().toLocaleDateString('zh-TW'));
    Logger.log('âœ… å·²å»ºç«‹æ–°è©¦ç®—è¡¨');
    Logger.log('ğŸ“Š è©¦ç®—è¡¨ç¶²å€: ' + newSs.getUrl());
    Logger.log('ğŸ“‹ è©¦ç®—è¡¨ ID: ' + newSs.getId());
    Logger.log('ğŸ’¡ è«‹å°‡ä¸Šæ–¹ ID è¤‡è£½åˆ°ç¨‹å¼ç¢¼çš„ CONFIG.SPREADSHEET_ID');
    return newSs;
    
  } catch (e) {
    Logger.log('âŒ ç„¡æ³•é–‹å•Ÿè©¦ç®—è¡¨: ' + e.toString());
    Logger.log('è«‹ç¢ºèªï¼š');
    Logger.log('1. SPREADSHEET_ID æ˜¯å¦æ­£ç¢º');
    Logger.log('2. æ‚¨æ˜¯å¦æœ‰è©²è©¦ç®—è¡¨çš„å­˜å–æ¬Šé™');
    throw new Error('ç„¡æ³•é–‹å•Ÿç›®æ¨™è©¦ç®—è¡¨: ' + e.message);
  }
}

/**
 * ä¸»å‡½å¼ï¼šå–å¾—å¤©æ°£è³‡æ–™ä¸¦å¯«å…¥è©¦ç®—è¡¨ï¼ˆç¨ç«‹å¼ç‰ˆæœ¬ï¼‰
 * âŒ ä¸èƒ½ä½¿ç”¨ getActiveSpreadsheet()
 * âŒ ä¸èƒ½ä½¿ç”¨ getUi()
 */
function fetchWeatherDataStandalone() {
  try {
    // âœ… ç¨ç«‹å¼è…³æœ¬å¿…é ˆæ˜ç¢ºæŒ‡å®šè©¦ç®—è¡¨
    const ss = getTargetSpreadsheet();
    const sheet = ss.getSheetByName(CONFIG.SHEET_NAME) || ss.insertSheet(CONFIG.SHEET_NAME);

    // 1. å–å¾— API Key
    const apiKey = getCWAApiKey();
    if (!apiKey) {
      throw new Error('æ‰¾ä¸åˆ° API Keyï¼Œè«‹å…ˆåŸ·è¡Œ setupCWAApiKey()');
    }

    // 2. çµ„åˆ API ç«¯é» URL
    const baseUrl = 'https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001';
    const params = {
      'Authorization': apiKey,
      'format': 'JSON'
    };
    const queryString = Object.keys(params)
      .map(k => `${k}=${encodeURIComponent(params[k])}`)
      .join('&');
    const url = `${baseUrl}?${queryString}`;

    Logger.log('ğŸ“¡ æ­£åœ¨å‘¼å« API...');
    Logger.log('ğŸ¯ ç›®æ¨™è©¦ç®—è¡¨: ' + ss.getName());
    Logger.log('ğŸ“„ ç›®æ¨™å·¥ä½œè¡¨: ' + sheet.getName());

    // 3. ä½¿ç”¨ UrlFetchApp ç™¼å‡º GET è«‹æ±‚
    const response = UrlFetchApp.fetch(url, {
      muteHttpExceptions: true
    });

    // 4. æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
    const statusCode = response.getResponseCode();
    if (statusCode !== 200) {
      throw new Error(`API è«‹æ±‚å¤±æ•— (ç‹€æ…‹ç¢¼: ${statusCode})`);
    }

    // 5. å–å¾—å›æ‡‰å…§å®¹ä¸¦è§£æ JSON å­—ä¸²
    const jsonString = response.getContentText();
    const data = JSON.parse(jsonString);

    // 6. é©—è­‰è³‡æ–™çµæ§‹
    if (!data.success || !data.records || !data.records.location) {
      throw new Error('API è³‡æ–™æ ¼å¼ä¸ç¬¦');
    }

    // 7. æ•´ç†è³‡æ–™
    const locations = data.records.location;
    const outputData = [];

    outputData.push([
      'ç¸£å¸‚', 'å¤©æ°£ç¾è±¡', 'æœ€ä½æº« (Â°C)', 'æœ€é«˜æº« (Â°C)', 
      'èˆ’é©åº¦', 'é™é›¨æ©Ÿç‡ (%)', 'è³‡æ–™æ›´æ–°æ™‚é–“'
    ]);

    // æ—¥æœŸè™•ç†
    let updateTime;
    try {
      const dateString = data.records.datasetDescription?.update 
                      || data.records.datasetDescription?.updateTime;
      updateTime = dateString ? new Date(dateString) : new Date();
      if (isNaN(updateTime.getTime())) {
        updateTime = new Date();
      }
    } catch (e) {
      updateTime = new Date();
    }

    locations.forEach(location => {
      const locationName = location.locationName;
      const weatherElements = location.weatherElement;

      const wxElement = weatherElements.find(el => el.elementName === 'Wx');
      const minTElement = weatherElements.find(el => el.elementName === 'MinT');
      const maxTElement = weatherElements.find(el => el.elementName === 'MaxT');
      const ciElement = weatherElements.find(el => el.elementName === 'CI');
      const popElement = weatherElements.find(el => el.elementName === 'PoP');

      const wx = wxElement ? wxElement.time[0].parameter.parameterName : 'N/A';
      const minT = minTElement ? minTElement.time[0].parameter.parameterName : 'N/A';
      const maxT = maxTElement ? maxTElement.time[0].parameter.parameterName : 'N/A';
      const ci = ciElement ? ciElement.time[0].parameter.parameterName : 'N/A';
      const pop = popElement ? popElement.time[0].parameter.parameterName : 'N/A';

      outputData.push([locationName, wx, minT, maxT, ci, pop, updateTime]);
    });

    // 8. å¯«å…¥è©¦ç®—è¡¨
    sheet.clear();
    sheet.getRange(1, 1, outputData.length, outputData[0].length).setValues(outputData);

    // 9. ç¾åŒ–è©¦ç®—è¡¨
    const headerRange = sheet.getRange(1, 1, 1, outputData[0].length);
    headerRange.setBackground('#4285F4')
               .setFontColor('#FFFFFF')
               .setFontWeight('bold')
               .setHorizontalAlignment('center');

    sheet.autoResizeColumns(1, outputData[0].length);
    sheet.setFrozenRows(1);
    
    if (outputData.length > 1) {
      const dateColumn = sheet.getRange(2, 7, outputData.length - 1, 1);
      dateColumn.setNumberFormat('yyyy/mm/dd hh:mm:ss');
    }

    // âŒ ç¨ç«‹å¼è…³æœ¬ä¸èƒ½ä½¿ç”¨ UIï¼Œåªèƒ½ç”¨ Logger
    Logger.log('âœ… å¤©æ°£è³‡æ–™å·²æˆåŠŸå¯«å…¥ Google Sheetï¼');
    Logger.log(`ğŸ“Š å…±å–å¾— ${locations.length} å€‹ç¸£å¸‚çš„å¤©æ°£é å ±`);
    Logger.log(`ğŸ•’ è³‡æ–™æ›´æ–°æ™‚é–“: ${formatDate(updateTime)}`);
    Logger.log(`ğŸ“Š è©¦ç®—è¡¨ç¶²å€: ${ss.getUrl()}`);
    Logger.log(`\nâœ… åŸ·è¡Œå®Œæˆï¼è«‹é–‹å•Ÿè©¦ç®—è¡¨æŸ¥çœ‹çµæœ`);

  } catch (e) {
    Logger.log("âŒ ç™¼ç”ŸéŒ¯èª¤: " + e.toString());
    Logger.log("éŒ¯èª¤å †ç–Š: " + e.stack);
    
    // å¯é¸ï¼šç™¼é€ Email é€šçŸ¥
    sendErrorEmail(e);
  }
}

/**
 * ç™¼é€éŒ¯èª¤é€šçŸ¥ Emailï¼ˆç¨ç«‹å¼è…³æœ¬çš„æ›¿ä»£æ–¹æ¡ˆï¼‰
 */
function sendErrorEmail(error) {
  try {
    const userEmail = Session.getActiveUser().getEmail();
    if (userEmail) {
      GmailApp.sendEmail(
        userEmail,
        'âŒ å¤©æ°£è³‡æ–™æ›´æ–°å¤±æ•—',
        `åŸ·è¡Œæ™‚é–“: ${new Date().toLocaleString('zh-TW')}\n\n` +
        `éŒ¯èª¤è¨Šæ¯: ${error.message}\n\n` +
        `éŒ¯èª¤å †ç–Š:\n${error.stack}\n\n` +
        `è«‹æŸ¥çœ‹ Apps Script åŸ·è¡Œè¨˜éŒ„ä»¥äº†è§£è©³æƒ…ã€‚`
      );
      Logger.log('ğŸ“§ å·²ç™¼é€éŒ¯èª¤é€šçŸ¥ Email');
    }
  } catch (emailError) {
    Logger.log('âš ï¸ ç„¡æ³•ç™¼é€ Email: ' + emailError.toString());
  }
}

/**
 * æ‰¹æ¬¡æ›´æ–°å¤šå€‹è©¦ç®—è¡¨ï¼ˆç¨ç«‹å¼è…³æœ¬çš„å„ªå‹¢ï¼‰
 */
function batchUpdateMultipleSpreadsheets() {
  const spreadsheetIds = [
    'SPREADSHEET_ID_1',
    'SPREADSHEET_ID_2',
    'SPREADSHEET_ID_3'
  ];
  
  Logger.log('ğŸ”„ é–‹å§‹æ‰¹æ¬¡æ›´æ–°...');
  
  spreadsheetIds.forEach((id, index) => {
    try {
      Logger.log(`\nè™•ç†ç¬¬ ${index + 1} å€‹è©¦ç®—è¡¨...`);
      
      // æš«æ™‚è¨­å®šç›®æ¨™è©¦ç®—è¡¨
      const originalId = CONFIG.SPREADSHEET_ID;
      CONFIG.SPREADSHEET_ID = id;
      
      // åŸ·è¡Œæ›´æ–°
      fetchWeatherDataStandalone();
      
      // æ¢å¾©åŸè¨­å®š
      CONFIG.SPREADSHEET_ID = originalId;
      
      Logger.log(`âœ… ç¬¬ ${index + 1} å€‹è©¦ç®—è¡¨æ›´æ–°å®Œæˆ`);
      
      // é¿å…è¶…éé…é¡ï¼Œç¨ä½œå»¶é²
      if (index < spreadsheetIds.length - 1) {
        Utilities.sleep(2000);
      }
      
    } catch (e) {
      Logger.log(`âŒ ç¬¬ ${index + 1} å€‹è©¦ç®—è¡¨æ›´æ–°å¤±æ•—: ${e.message}`);
    }
  });
  
  Logger.log('\nâœ… æ‰¹æ¬¡æ›´æ–°å®Œæˆï¼');
}

/**
 * é™¤éŒ¯å‡½å¼
 */
function debugAPIResponse() {
  const apiKey = getCWAApiKey();
  
  if (!apiKey) {
    Logger.log('âŒ è«‹å…ˆè¨­å®š API Keyï¼ˆåŸ·è¡Œ setupCWAApiKeyï¼‰');
    return;
  }

  const baseUrl = 'https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001';
  const url = `${baseUrl}?Authorization=${apiKey}&format=JSON`;

  try {
    const response = UrlFetchApp.fetch(url);
    const data = JSON.parse(response.getContentText());
    
    Logger.log('=== API å›æ‡‰çµæ§‹ ===');
    Logger.log('success: ' + data.success);
    Logger.log('records å­˜åœ¨: ' + (data.records ? 'Yes' : 'No'));
    
    if (data.records && data.records.datasetDescription) {
      Logger.log('\n=== æ—¥æœŸæ¬„ä½è³‡è¨Š ===');
      Logger.log(JSON.stringify(data.records.datasetDescription, null, 2));
    }
    
    Logger.log('\nâœ… é™¤éŒ¯å®Œæˆ');
  } catch (e) {
    Logger.log('âŒ éŒ¯èª¤: ' + e.toString());
  }
}

/**
 * æ¸¬è©¦é…ç½®ï¼ˆç¢ºèªè©¦ç®—è¡¨å¯æ­£å¸¸é–‹å•Ÿï¼‰
 */
function testConfiguration() {
  Logger.log('=== æ¸¬è©¦é…ç½® ===');
  
  try {
    const ss = getTargetSpreadsheet();
    Logger.log('âœ… æˆåŠŸé–‹å•Ÿè©¦ç®—è¡¨');
    Logger.log('ğŸ“Š è©¦ç®—è¡¨åç¨±: ' + ss.getName());
    Logger.log('ğŸ“‹ è©¦ç®—è¡¨ ID: ' + ss.getId());
    Logger.log('ğŸ”— è©¦ç®—è¡¨ç¶²å€: ' + ss.getUrl());
    
    const apiKey = getCWAApiKey();
    if (apiKey) {
      Logger.log('âœ… API Key å·²è¨­å®š');
    } else {
      Logger.log('âš ï¸ å°šæœªè¨­å®š API Key');
      Logger.log('è«‹åŸ·è¡Œ setupCWAApiKey() å‡½å¼');
    }
    
    Logger.log('\nâœ… é…ç½®æ¸¬è©¦å®Œæˆ');
  } catch (e) {
    Logger.log('âŒ é…ç½®æ¸¬è©¦å¤±æ•—: ' + e.toString());
    Logger.log('\nè«‹æª¢æŸ¥ï¼š');
    Logger.log('1. CONFIG.SPREADSHEET_ID æ˜¯å¦æ­£ç¢º');
    Logger.log('2. æ‚¨æ˜¯å¦æœ‰è©²è©¦ç®—è¡¨çš„å­˜å–æ¬Šé™');
  }
}

/**
 * å»ºç«‹å®šæ™‚è§¸ç™¼å™¨ï¼ˆç¨ç«‹å¼ç‰ˆæœ¬ï¼‰
 */
function createHourlyTrigger() {
  // åˆªé™¤ç¾æœ‰è§¸ç™¼å™¨
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'fetchWeatherDataStandalone') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  // å»ºç«‹æ–°è§¸ç™¼å™¨
  ScriptApp.newTrigger('fetchWeatherDataStandalone')
    .timeBased()
    .everyHours(1)
    .create();
  
  Logger.log('âœ… å·²è¨­å®šæ¯å°æ™‚è‡ªå‹•æ›´æ–°');
}
```

#### æ­¥é©Ÿ 3ï¼šé…ç½®è©¦ç®—è¡¨

**é¸é … 1ï¼šä½¿ç”¨ç¾æœ‰è©¦ç®—è¡¨**
1. é–‹å•Ÿæ‚¨è¦æ›´æ–°çš„è©¦ç®—è¡¨
2. å¾ç¶²å€è¤‡è£½è©¦ç®—è¡¨ ID
   ```
   https://docs.google.com/spreadsheets/d/[é€™æ®µå°±æ˜¯ID]/edit
   ```
3. å°‡ ID è²¼åˆ°ç¨‹å¼ç¢¼çš„ `CONFIG.SPREADSHEET_ID`

**é¸é … 2ï¼šå»ºç«‹æ–°è©¦ç®—è¡¨**
1. ä¿æŒ `CONFIG.SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE'`
2. ç›´æ¥åŸ·è¡Œ `fetchWeatherDataStandalone()`
3. æŸ¥çœ‹åŸ·è¡Œè¨˜éŒ„ï¼Œæœƒé¡¯ç¤ºæ–°å»ºè©¦ç®—è¡¨çš„ç¶²å€å’Œ ID
4. å°‡ ID æ›´æ–°åˆ°ç¨‹å¼ç¢¼ä¸­

#### æ­¥é©Ÿ 4ï¼šåŸ·è¡Œèˆ‡æ¸¬è©¦
1. åŸ·è¡Œ `testConfiguration()` ç¢ºèªé…ç½®æ­£ç¢º
2. åŸ·è¡Œ `setupCWAApiKey()` è¨­å®š API Key
3. åŸ·è¡Œ `fetchWeatherDataStandalone()`
4. æŸ¥çœ‹åŸ·è¡Œè¨˜éŒ„ï¼Œå–å¾—è©¦ç®—è¡¨ç¶²å€
5. é–‹å•Ÿè©¦ç®—è¡¨æŸ¥çœ‹çµæœ

---