**ç¹«çµå¼è…³æœ¬ï¼ˆBound Scriptï¼‰** æ˜¯ç›´æ¥ä¾é™„åœ¨æŸå€‹ Google æ–‡ä»¶ï¼ˆè©¦ç®—è¡¨ã€æ–‡ä»¶ã€ç°¡å ±ã€è¡¨å–®ï¼‰ä¸‹çš„è…³æœ¬ã€‚

**ç‰¹é»ï¼š**
- âœ… èˆ‡æ–‡ä»¶ç¶å®šï¼Œç„¡æ³•åˆ†é›¢
- âœ… å¯ç›´æ¥å­˜å–æ‰€åœ¨çš„æ–‡ä»¶
- âœ… å¯å»ºç«‹è‡ªè¨‚é¸å–®å’Œ UI
- âœ… é©åˆå–®ä¸€æª”æ¡ˆçš„è‡ªå‹•åŒ–

**å»ºç«‹æ–¹å¼ï¼š**
1. é–‹å•Ÿ Google è©¦ç®—è¡¨
2. é»æ“Šã€Œæ“´å……åŠŸèƒ½ã€â†’ã€ŒApps Scriptã€

---

## æ–¹æ³• 1ï¼šç¹«çµå¼è…³æœ¬ï¼ˆBound Scriptï¼‰

### ğŸ“‹ ä½¿ç”¨å ´æ™¯
- ç‚º**ç‰¹å®šè©¦ç®—è¡¨**å»ºç«‹è‡ªå‹•åŒ–åŠŸèƒ½
- éœ€è¦è‡ªè¨‚é¸å–®å’Œ UI äº’å‹•
- åœ˜éšŠå…±äº«æ–‡ä»¶æ™‚ä¸€èµ·å…±äº«è…³æœ¬

### ğŸ¯ å»ºç«‹æ­¥é©Ÿ

#### æ­¥é©Ÿ 1ï¼šé–‹å•Ÿè©¦ç®—è¡¨ä¸¦å»ºç«‹è…³æœ¬
1. é–‹å•Ÿæˆ–å»ºç«‹ä¸€å€‹ Google è©¦ç®—è¡¨
2. é»æ“Šã€Œæ“´å……åŠŸèƒ½ã€â†’ã€ŒApps Scriptã€
3. åˆªé™¤é è¨­çš„ç¨‹å¼ç¢¼
4. è²¼ä¸Šä¸‹æ–¹çš„å®Œæ•´ç¨‹å¼ç¢¼

#### æ­¥é©Ÿ 2ï¼šå®Œæ•´ç¨‹å¼ç¢¼

```javascript
/**
 * ==========================================
 * ç¹«çµå¼è…³æœ¬ç‰ˆæœ¬ - å¤©æ°£è³‡æ–™æŠ“å–å·¥å…·
 * ==========================================
 * æ­¤è…³æœ¬ä¾é™„æ–¼ç•¶å‰è©¦ç®—è¡¨ï¼Œå¯ç›´æ¥ä½¿ç”¨ getActiveSpreadsheet()
 */

/**
 * ç•¶è©¦ç®—è¡¨é–‹å•Ÿæ™‚è‡ªå‹•åŸ·è¡Œï¼Œå»ºç«‹è‡ªè¨‚é¸å–®
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('ğŸŒ¤ï¸ å¤©æ°£å·¥å…·')
    .addItem('ğŸ“¥ æ›´æ–°å¤©æ°£è³‡æ–™', 'fetchWeatherDataBound')
    .addItem('âš™ï¸ è¨­å®š API Key', 'setupCWAApiKeyWithUI')
    .addItem('ğŸ—‘ï¸ æ¸…é™¤è³‡æ–™', 'clearWeatherData')
    .addSeparator()
    .addItem('ğŸ” é™¤éŒ¯ API', 'debugAPIResponse')
    .addItem('ğŸ“– ä½¿ç”¨èªªæ˜', 'showHelp')
    .addToUi();
  
  Logger.log('âœ… è‡ªè¨‚é¸å–®å·²å»ºç«‹');
}

/**
 * å®‰å…¨çš„æ—¥æœŸæ ¼å¼åŒ–å‡½å¼
 */
function formatDate(date) {
  try {
    if (!date || isNaN(date.getTime())) {
      return 'æ—¥æœŸç„¡æ•ˆ';
    }
    const timezone = Session.getScriptTimeZone();
    return Utilities.formatDate(date, timezone, 'yyyy/MM/dd HH:mm:ss');
  } catch (e) {
    return 'ç„¡æ³•æ ¼å¼åŒ–æ—¥æœŸ';
  }
}

/**
 * è¨­å®š API Keyï¼ˆå¸¶ UIï¼‰
 */
function setupCWAApiKeyWithUI() {
  const ui = SpreadsheetApp.getUi();
  
  const response = ui.prompt(
    'âš™ï¸ è¨­å®šä¸­å¤®æ°£è±¡ç½² API Key',
    'è«‹è¼¸å…¥æ‚¨çš„ API Key (æ ¼å¼: CWA-XXXXXXXX-...)ï¼š',
    ui.ButtonSet.OK_CANCEL
  );
  
  if (response.getSelectedButton() == ui.Button.OK) {
    const apiKey = response.getResponseText().trim();
    
    if (apiKey && apiKey.startsWith('CWA-')) {
      PropertiesService.getScriptProperties().setProperty('CWA_API_KEY', apiKey);
      ui.alert('âœ… API Key å·²æˆåŠŸå„²å­˜ï¼', ui.ButtonSet.OK);
      Logger.log('âœ… API Key å·²å„²å­˜');
    } else {
      ui.alert('âš ï¸ API Key æ ¼å¼ä¸æ­£ç¢º', 'è«‹ç¢ºèªæ ¼å¼ç‚º: CWA-XXXXXXXX-...', ui.ButtonSet.OK);
    }
  }
}

/**
 * å–å¾— API Key
 */
function getCWAApiKey() {
  return PropertiesService.getScriptProperties().getProperty('CWA_API_KEY');
}

/**
 * ä¸»å‡½å¼ï¼šå–å¾—å¤©æ°£è³‡æ–™ä¸¦å¯«å…¥è©¦ç®—è¡¨ï¼ˆç¹«çµå¼ç‰ˆæœ¬ï¼‰
 * âœ… å¯ä»¥ä½¿ç”¨ getActiveSpreadsheet()
 * âœ… å¯ä»¥ä½¿ç”¨ getUi()
 */
function fetchWeatherDataBound() {
  const ui = SpreadsheetApp.getUi();
  
  // âœ… ç¹«çµå¼è…³æœ¬å¯ä»¥ç›´æ¥ä½¿ç”¨ getActiveSpreadsheet()
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("å¤©æ°£é å ±") || ss.insertSheet("å¤©æ°£é å ±");

  try {
    // 1. å–å¾— API Key
    const apiKey = getCWAApiKey();
    if (!apiKey) {
      ui.alert('âš ï¸ æ‰¾ä¸åˆ° API Key', 'è«‹å…ˆåŸ·è¡Œã€Œâš™ï¸ è¨­å®š API Keyã€', ui.ButtonSet.OK);
      return;
    }

    // 2. çµ„åˆ API ç«¯é» URL
    const baseUrl = 'https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001';
    const params = {
      'Authorization': apiKey,
      'format': 'JSON'
    };
    const queryString = Object.keys(params)
      .map(k => `${k}=${encodeURIComponent(params[k])}`)
      .join('&');
    const url = `${baseUrl}?${queryString}`;

    Logger.log('ğŸ“¡ æ­£åœ¨å‘¼å« API...');

    // 3. ä½¿ç”¨ UrlFetchApp ç™¼å‡º GET è«‹æ±‚
    const response = UrlFetchApp.fetch(url, {
      muteHttpExceptions: true
    });

    // 4. æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
    const statusCode = response.getResponseCode();
    if (statusCode !== 200) {
      throw new Error(`API è«‹æ±‚å¤±æ•— (ç‹€æ…‹ç¢¼: ${statusCode})`);
    }

    // 5. å–å¾—å›æ‡‰å…§å®¹ä¸¦è§£æ JSON å­—ä¸²
    const jsonString = response.getContentText();
    const data = JSON.parse(jsonString);

    // 6. é©—è­‰è³‡æ–™çµæ§‹
    if (!data.success || !data.records || !data.records.location) {
      throw new Error('API è³‡æ–™æ ¼å¼ä¸ç¬¦');
    }

    // 7. æ•´ç†è³‡æ–™
    const locations = data.records.location;
    const outputData = [];

    outputData.push([
      'ç¸£å¸‚', 'å¤©æ°£ç¾è±¡', 'æœ€ä½æº« (Â°C)', 'æœ€é«˜æº« (Â°C)', 
      'èˆ’é©åº¦', 'é™é›¨æ©Ÿç‡ (%)', 'è³‡æ–™æ›´æ–°æ™‚é–“'
    ]);

    // æ—¥æœŸè™•ç†
    let updateTime;
    try {
      const dateString = data.records.datasetDescription?.update 
                      || data.records.datasetDescription?.updateTime;
      updateTime = dateString ? new Date(dateString) : new Date();
      if (isNaN(updateTime.getTime())) {
        updateTime = new Date();
      }
    } catch (e) {
      updateTime = new Date();
    }

    locations.forEach(location => {
      const locationName = location.locationName;
      const weatherElements = location.weatherElement;

      const wxElement = weatherElements.find(el => el.elementName === 'Wx');
      const minTElement = weatherElements.find(el => el.elementName === 'MinT');
      const maxTElement = weatherElements.find(el => el.elementName === 'MaxT');
      const ciElement = weatherElements.find(el => el.elementName === 'CI');
      const popElement = weatherElements.find(el => el.elementName === 'PoP');

      const wx = wxElement ? wxElement.time[0].parameter.parameterName : 'N/A';
      const minT = minTElement ? minTElement.time[0].parameter.parameterName : 'N/A';
      const maxT = maxTElement ? maxTElement.time[0].parameter.parameterName : 'N/A';
      const ci = ciElement ? ciElement.time[0].parameter.parameterName : 'N/A';
      const pop = popElement ? popElement.time[0].parameter.parameterName : 'N/A';

      outputData.push([locationName, wx, minT, maxT, ci, pop, updateTime]);
    });

    // 8. å¯«å…¥è©¦ç®—è¡¨
    sheet.clear();
    sheet.getRange(1, 1, outputData.length, outputData[0].length).setValues(outputData);

    // 9. ç¾åŒ–è©¦ç®—è¡¨
    const headerRange = sheet.getRange(1, 1, 1, outputData[0].length);
    headerRange.setBackground('#4285F4')
               .setFontColor('#FFFFFF')
               .setFontWeight('bold')
               .setHorizontalAlignment('center');

    sheet.autoResizeColumns(1, outputData[0].length);
    sheet.setFrozenRows(1);
    
    if (outputData.length > 1) {
      const dateColumn = sheet.getRange(2, 7, outputData.length - 1, 1);
      dateColumn.setNumberFormat('yyyy/mm/dd hh:mm:ss');
    }

    // âœ… ç¹«çµå¼è…³æœ¬å¯ä»¥ä½¿ç”¨ UI
    ui.alert(
      'âœ… å¤©æ°£è³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼',
      `å…±å–å¾— ${locations.length} å€‹ç¸£å¸‚çš„å¤©æ°£é å ±\nè³‡æ–™æ›´æ–°æ™‚é–“: ${formatDate(updateTime)}`,
      ui.ButtonSet.OK
    );

    Logger.log(`âœ… æˆåŠŸå¯«å…¥ ${locations.length} ç­†è³‡æ–™`);

  } catch (e) {
    // âœ… ç¹«çµå¼è…³æœ¬å¯ä»¥ä½¿ç”¨ UI é¡¯ç¤ºéŒ¯èª¤
    ui.alert(
      'âŒ åŸ·è¡Œå¤±æ•—',
      `éŒ¯èª¤è¨Šæ¯: ${e.message}\n\nè«‹æŸ¥çœ‹åŸ·è¡Œè¨˜éŒ„ä»¥äº†è§£è©³æƒ…ã€‚`,
      ui.ButtonSet.OK
    );
    Logger.log("âŒ éŒ¯èª¤: " + e.toString());
    Logger.log("å †ç–Š: " + e.stack);
  }
}

/**
 * æ¸…é™¤å¤©æ°£è³‡æ–™
 */
function clearWeatherData() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("å¤©æ°£é å ±");
  
  if (!sheet) {
    ui.alert('âš ï¸ æ‰¾ä¸åˆ°ã€Œå¤©æ°£é å ±ã€å·¥ä½œè¡¨');
    return;
  }
  
  const response = ui.alert(
    'ç¢ºèªæ¸…é™¤',
    'ç¢ºå®šè¦æ¸…é™¤ã€Œå¤©æ°£é å ±ã€å·¥ä½œè¡¨çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿ',
    ui.ButtonSet.YES_NO
  );
  
  if (response == ui.Button.YES) {
    sheet.clear();
    ui.alert('âœ… è³‡æ–™å·²æ¸…é™¤');
    Logger.log('âœ… å¤©æ°£é å ±è³‡æ–™å·²æ¸…é™¤');
  }
}

/**
 * é™¤éŒ¯å‡½å¼
 */
function debugAPIResponse() {
  const ui = SpreadsheetApp.getUi();
  const apiKey = getCWAApiKey();
  
  if (!apiKey) {
    ui.alert('âš ï¸ è«‹å…ˆè¨­å®š API Key');
    return;
  }

  const baseUrl = 'https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001';
  const url = `${baseUrl}?Authorization=${apiKey}&format=JSON`;

  try {
    const response = UrlFetchApp.fetch(url);
    const data = JSON.parse(response.getContentText());
    
    Logger.log('=== API å›æ‡‰çµæ§‹ ===');
    Logger.log('success: ' + data.success);
    Logger.log('records å­˜åœ¨: ' + (data.records ? 'Yes' : 'No'));
    
    if (data.records && data.records.datasetDescription) {
      Logger.log('\n=== æ—¥æœŸæ¬„ä½è³‡è¨Š ===');
      Logger.log(JSON.stringify(data.records.datasetDescription, null, 2));
    }
    
    ui.alert('âœ… é™¤éŒ¯å®Œæˆ', 'è«‹æŸ¥çœ‹ã€ŒåŸ·è¡Œè¨˜éŒ„ã€ä»¥äº†è§£è©³æƒ…', ui.ButtonSet.OK);
  } catch (e) {
    ui.alert('âŒ é™¤éŒ¯å¤±æ•—', e.message, ui.ButtonSet.OK);
    Logger.log('âŒ éŒ¯èª¤: ' + e.toString());
  }
}

/**
 * é¡¯ç¤ºä½¿ç”¨èªªæ˜
 */
function showHelp() {
  const ui = SpreadsheetApp.getUi();
  const helpText = 
    'ğŸ“– ç¹«çµå¼è…³æœ¬ä½¿ç”¨èªªæ˜\n\n' +
    'ğŸ¯ ç‰¹è‰²ï¼š\n' +
    '  â€¢ ç›´æ¥ä¾é™„åœ¨æ­¤è©¦ç®—è¡¨ä¸Š\n' +
    '  â€¢ å¯ä½¿ç”¨è‡ªè¨‚é¸å–®\n' +
    '  â€¢ é©åˆå–®ä¸€æ–‡ä»¶çš„è‡ªå‹•åŒ–\n\n' +
    'ğŸ“ ä½¿ç”¨æ­¥é©Ÿï¼š\n' +
    '1ï¸âƒ£ é»æ“Šã€Œâš™ï¸ è¨­å®š API Keyã€\n' +
    '2ï¸âƒ£ é»æ“Šã€ŒğŸ“¥ æ›´æ–°å¤©æ°£è³‡æ–™ã€\n' +
    '3ï¸âƒ£ æŸ¥çœ‹ã€Œå¤©æ°£é å ±ã€å·¥ä½œè¡¨\n\n' +
    'ğŸ”— å–å¾— API Keyï¼š\n' +
    '   https://opendata.cwa.gov.tw\n\n' +
    'â“ å•é¡Œæ’è§£ï¼š\n' +
    '   æŸ¥çœ‹ã€Œæ“´å……åŠŸèƒ½ â†’ Apps Script â†’ åŸ·è¡Œè¨˜éŒ„ã€';
  
  ui.alert('ğŸŒ¤ï¸ å¤©æ°£å·¥å…·ä½¿ç”¨èªªæ˜', helpText, ui.ButtonSet.OK);
}

/**
 * å»ºç«‹å®šæ™‚è§¸ç™¼å™¨
 */
function createHourlyTrigger() {
  // åˆªé™¤ç¾æœ‰è§¸ç™¼å™¨
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'fetchWeatherDataBound') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  // å»ºç«‹æ–°è§¸ç™¼å™¨
  ScriptApp.newTrigger('fetchWeatherDataBound')
    .timeBased()
    .everyHours(1)
    .create();
  
  const ui = SpreadsheetApp.getUi();
  ui.alert('âœ… å·²è¨­å®šæ¯å°æ™‚è‡ªå‹•æ›´æ–°');
  Logger.log('âœ… å·²è¨­å®šå®šæ™‚è§¸ç™¼å™¨');
}
```

#### æ­¥é©Ÿ 3ï¼šåŸ·è¡Œèˆ‡æ¸¬è©¦
1. é‡æ–°æ•´ç†è©¦ç®—è¡¨ï¼Œæœƒçœ‹åˆ°ã€ŒğŸŒ¤ï¸ å¤©æ°£å·¥å…·ã€é¸å–®
2. é»æ“Šã€Œâš™ï¸ è¨­å®š API Keyã€è¼¸å…¥æ‚¨çš„ API Key
3. é»æ“Šã€ŒğŸ“¥ æ›´æ–°å¤©æ°£è³‡æ–™ã€
4. æŸ¥çœ‹ã€Œå¤©æ°£é å ±ã€å·¥ä½œè¡¨
